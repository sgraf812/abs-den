\section{Abstract Interpretation}
\label{sec:abstractions}

\subsection{Lazy Denotational Deadness}

Let us now finally try to reformulate semantic deadness in terms of
$\semevt{\wild}$ and $\equiv$:

\begin{definition}[Denotational deadness, lazily]
  \label{defn:deadness3}
  An address $\pa$ is \emph{dead} in a denotation $d$ if and only if,
  for all $μ_1 \approx μ_2$ such that $\pa$ is dead in $\rng(μ_i)$,
  $\dom(μ_1) ∪ \{\pa\} ⊦ d$ and $d_1,d_2$, we have
  \[
    \dom(μ_1) ⊦ d(μ_1[\pa↦d_1]) \sim d(μ_2[\pa↦d_2]).
  \]
  A variable $\px$ is \emph{dead} in an expression $\pe$ if and only if
  any $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\pa]}$ for any $ρ$ such
  that $\pa \not∈ \rng(ρ)$.
  Otherwise, $\px$ is \emph{live}.
\end{definition}

So if $x$ is dead in $\pe_2$, we can justify the following rewrite by
irrelevance:
\[
  \Let{x}{\pe_1}{\pe_2} \equiv \Let{x}{\mathit{panic}}{\pe_2}
\]
A syntactic \emph{occurrence analysis} could subsequently figure out whether the
binding for $x$ can be dropped without introducing scoping errors, a feat
that becomes far simpler once huge expressions $\pe_1$ are turned into small
$\mathit{panic}$s.

\begin{toappendix}
\begin{lemma}[Heap partitioning]
  \label{thm:heap-partitioning}
  Let $μ$ be a heap and $\pa ∈ \dom(μ)$.
  Then there exists a heap $μ_h$ with domain $\dom(μ_h) \setminus \{ \pa \}$
  and $μ \approx μ_h[\pa↦μ(\pa)]$.
\end{lemma}
\begin{proof}
  Define $μ_h \triangleq \mathit{hide}_\pa(μ)$, where
  \[\begin{array}{rcl}
    \mathit{hide}_\pa(μ)(\pa')(μ') & = & \begin{cases}
      μ(\pa')(μ'[\pa↦μ(\pa)]) & \pa' ∈ \dom(μ) \setminus \{ \pa \} \\
      \mathit{undefined} & \text{otherwise} \\
    \end{cases}
  \end{array}\]
  We abbreviate $μ_h \triangleq \mathit{hide}_\pa(μ)$.
  Clearly, $\dom(μ_h) = \dom(μ) \setminus \{ \pa \}$.

  By Löb induction, we prove
  \[
    μ_h \text{ is lazy and extensional} \wedge μ \approx μ_h[\pa↦μ(\pa)]
  \]
  So we assume that the property holds later.

  Consider $d \triangleq μ_h(\pa') = \fn{μ'}{μ(\pa')(μ'[\pa↦μ(\pa)])}$ for some $\pa' ∈ \dom(μ_h)$.
  Then $d(μ_h) = μ(\pa')(μ_h[\pa↦μ(\pa)])$ which is defined, because
  $μ(\pa')(μ)$ is defined and $μ(\pa')$ is extensional, which we can apply to
  $μ \approx μ_h[\pa↦μ(\pa)]$ later.

  Furthermore, $d$ is lazy for a similar argument that the $\mathbf{let}$ case
  of \Cref{thm:semevt-lazy} is.
  Extensionality follows because the heap extension $[\pa↦μ(\pa)]$ in $d$ is
  always with the same (extensional) element.

  For $μ \approx μ_h[\pa↦μ(\pa)]$, we unfold $\mathit{hide}_\pa$, fix
  $\pa' ∈ \dom(μ)$ and show
  \[
    \dom(μ) ⊦ μ(\pa')(μ) \sim μ(\pa')(μ_h[\pa↦μ(\pa)])
  \]
  Which can be shown by extensionality of $μ(\pa')$ applied to the induction
  hypothesis.
\end{proof}

\begin{lemma}
  \label{thm:adom-dead}
  Let $A ⊦ d$. Then any $\pa \not∈ A$ is dead in $d$.
\end{lemma}
\begin{proof}
  Assume $μ_1 \approx μ_2$ such that $\pa$ is dead in $\rng(μ_i)$ and $\dom(μ_1) ∪ \{\pa\} ⊦ d$
  and fix arbitrary $d_1,d_2$.
  We have to show that
  \[
    \dom(μ_1) ⊦ d(μ_1[\pa↦d_1]) \sim d(μ_2[\pa↦d_2])
  \]

  We assume that $A ⊆ \dom(μ_i)$.
  Otherwise, we can extend $μ_i$ to heaps $μ_i'$ (mapping to equal entries, for
  example $d$) such that $A ⊆ \dom(μ_i')$.
  Then $μ_i \forcesto μ_i'$ and we can apply \Cref{thm:lazy-force-bisimilar}.

  W.l.o.g., $A ⊆ \dom(μ_i)$.
  By \Cref{thm:heap-partitioning}, there exist $μ_i'$ such that $μ_i[\pa↦d_i] \approx μ_i'[\pa↦d_i]$
  and $\pa \not∈ \dom(μ_i')$, so $μ_i' \forcesto μ_i'[\pa↦d_i]$.
  By extensionality of $d$, we know that
  \[
    \dom(μ_1') ⊦ d(μ_1') \sim d(μ_2')
  \]
  Since $A ⊆ \dom(μ_i')$ and $A ⊦ d$, we can apply \Cref{thm:lazy-force-bisimilar}, getting
  \[
    \dom(μ_1') ⊦ d(μ_1'[\pa↦d_i]) \sim d(μ_2'[\pa↦d_i])
  \]
  And again by extensionality applied to $μ_i[\pa↦d_i] \approx μ_i'[\pa↦d_i]$
  and transitivity, we show the goal.
\end{proof}

\begin{lemmarep}[Deadness implies irrelevance]
  If $\px$ is dead in $\pe$,
  then for all $ρ, \pe_1,\pe_2$,
  \[\semevt{\Let{\px}{\pe_1}{\pe}}_{ρ} \equiv \semevt{\Let{\px}{\pe_2}{\pe}}_{ρ}.\]
\end{lemmarep}
\begin{proof}
  Assume that $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\pa]}$ for any
  $ρ$ such that $\pa \not∈ \rng(ρ)$.
  To show that
  \[
    \semevt{\Let{\px}{\pe_1}{\pe}}_ρ \equiv \semevt{\Let{\px}{\pe_1}{\pe}}_ρ,
  \]
  we assume that $μ_1 \approx μ_2$ for arbitrary $μ_1,μ_2$ (satisfying
  well-addressedness constraints) and show that
  \[
    \dom(μ_1) ⊦ \semevt{\Let{\px}{\pe_1}{\pe}}_{ρ}(μ_1) \sim \semevt{\Let{\px}{\pe_2}{\pe}}_{ρ}(μ_2)
  \]
  We unfold the $\mathbf{let}$ case of $\semevt{\wild}$ and show
  \[
    \dom(μ_1) ⊦ \semevt{\pe}_{ρ[\px↦\pa]}(μ_1[\pa↦d_1]) \sim \semevt{\pe}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  For arbitrary $d_1,d_2$ (which we may set to
  $d_i \triangleq \memo(\pa,\semevt{\pe_i}_{ρ[\px↦\pa]})$).
  But $\pa \not∈ \rng(ρ)$ due to \Cref{thm:well-addressedness},
  so $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\pa]}$ per assumption.
  Hence we can show the goal, applying to $μ_1 \approx μ_2$.
\end{proof}
\end{toappendix}

We can now prove \Cref{thm:semusg-correct-live} in terms of this new
characterisation of deadness by induction:

\begin{theoremrep}[$\semusg{\wild}$ is a correct deadness analysis]
  \label{thm:semusg-correct-live-3}
  Let $\pe$ be an expression, $\px$ a variable and $\tr$ a usage environment.
  If $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$
  then $\px$ is dead in $\pe$.
\end{theoremrep}
\begin{proof}
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$.
  So we assume that an address $\pa$ is dead in the range of an
  environment $ρ$ and show that $\pa$ is dead in
  $\semevt{\pe}_{ρ[\px↦\pa]}$.

  We assume that $μ_1 \approx μ_2$ such that $\pa$ is dead in $\rng(μ_i)$, $\dom(μ_1) ∪ \{\pa\} ⊦ \semevt{\pe}_{ρ[\px↦\pa]}$ and
  abbreviate $A \triangleq \dom(μ_1)$. Then the goal is to show
  \[
    A ⊦ \semevt{\pe}_{ρ[\px↦\pa]}(μ_1[\pa↦d_1]) \sim \semevt{\pe}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  for any $d_1,d_2$ and $ρ$ such that $\pa$ is dead in $\rng(ρ)$.
  We proceed by induction on $\pe$.
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then
      $\semusg{\py}_{\tr} = \semusg{\px}_{\tr}$, contradicting the inequality.
      If $\px \not= \py$, then $\pa$ is dead in $\semevt{\py}_{ρ[\px↦\pa]}=ρ(\py)$.

    \item \textbf{Case $\pe = \Lam{\py}{\pe'}$}:
      We abbreviate
      $μ_i' \triangleq μ_i[\pa↦d_i]$, $ρ' \triangleq ρ[\px↦\pa]$
      and have to show
      \[
        A ⊦ \goodend{\FunV(\fn{d}{\semevt{\pe'}_{ρ'[\py↦d]}}), μ_1'} \sim \goodend{\FunV(\fn{d}{\semevt{\pe'}_{ρ'[\py↦d]}}), μ_2'},
      \]
      which requires us to show
      \[
        \forall d.\ \later (A ⊦ d) ⟹  A ⊦ \semevt{\pe'}_{ρ'[\py↦d]}(μ_1') \sim \semevt{\pe'}_{ρ'[\py↦d]}(μ_2')
      \]
      Crucially, the address restriction on $d$ means that $\pa$ is dead in $d$
      per \Cref{thm:adom-dead}, so the proof is a simple matter of applying the
      inductive hypothesis.

    \item \textbf{Case $\pe = \pe'~\py$}:
      $\pa$ is trivially dead in the stuck case, so we assume that there exists
      $d_\py \triangleq ρ(\py)$ and $\pa$ is dead in $d_\py$ per assumption.
      We unfold $\apply$ and abbreviate
      $d_{\pe'} \triangleq \semevt{\pe'}_{ρ[\px↦\pa]}$,
      $k \triangleq \fn{(\FunV(f))}{f(d_\py)}$, so the goal is to prove
      \[
        A ⊦ (d_{\pe'} \betastep k)(μ_1[\pa↦d_1]) \sim (d_{\pe'} \betastep k)(μ_2[\pa↦d_2])
      \]
      Since $d_{\pe'} \equiv d_{\pe'}$, the only interesting case is when
      $\bigstep{d_{\pe'}}{μ_i[\pa↦d_i]}{\FunV(f_i)}{μ_i'}$, in which case we
      have to show that
      \[
        A ⊦ f_1(d_\py)(μ_1') \sim f_2(d_\py)(μ_2').
      \]
      But $A ⊦ d_\py$ by \Cref{thm:well-addressedness}, so we can apply the
      premise of the $\eqfun$ judgment at the end of the $d_{\pe'}$ trace.

    \item \textbf{Case $\pe = \Let{\py}{\pe_1}{\pe_2}$}:
      We abbreviate
      ${ρ' \triangleq ρ[\px↦\pa]}$,
      $d_{\pe_i} \triangleq \semevt{\pe_i}_{ρ'[\py↦\pa']}$,
      ${μ_i' \triangleq μ_i[\pa↦d_i]}$,
      so the goal is to prove
      \[
        A ⊦ d_{\pe_2}(μ_1[\pa↦d_1][\pa'↦d_{\pe_1}]) \sim d_{\pe_2}(μ_2[\pa↦d_2][\pa'↦d_{\pe_1}])
      \]
      where $\pa' \not∈ \dom(μ_i)$ and $\pa' \not= \pa$.

      Since there can be no shadowing, it is $\px \not= \py$ and we see that
      $\tr(\px) = \tr'(\px)$, where
      $\tr' \triangleq {\operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦
      [\py↦1]+\semusg{\pe_1}_{\tr'}]})}$.
      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      but we cannot apply the induction hypothesis yet, because
      $\pa$ might not be dead in $d_{\pe_1}$ and thus not in
      $μ_i[\pa'↦d_{\pe_1}]$.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite $d_{\pe_1}$ to
          $d_{\pe_1}' \triangleq \semevt{\Lam{x}{x}}_{[]}$, and $\pa$ is dead in that.
          Then we apply the induction hypothesis to the heaps
          $μ_i[\pa'↦d_{\pe_1}']$ (noting that $μ_1[\pa'↦d_{\pe_1}'] \approx
          μ_2[\pa'↦d_{\pe_1}']$ and that $\pa$ is dead in the range of both) and
          then rewrite back to $d_{\pe_1}$:
          \[\begin{array}{rcl}
            A & ⊦    & \semevt{\pe_2}_{ρ'[\py↦\pa']}(μ_1[\pa'↦d_{\pe_1}]) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\pa']}(μ_1[\pa'↦d_{\pe_1}']) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\pa']}(μ_2[\pa'↦d_{\pe_1}']) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\pa']}(μ_2[\pa'↦d_{\pe_1}]) \\
          \end{array}\]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\pa$ is dead in $d_{\pe_1}$ and thus in the range of
          $μ_i[\pa'↦d_{\pe_i}']$ and we may invoke the induction hypothesis
          directly to show the goal.
      \end{itemize}
  \end{itemize}
\end{proof}

\subsection{Discussion}

The main proof of \Cref{thm:semusg-correct-live-3} is hardly longer than
\Cref{thm:semusg-correct-live}, but we have to admit that we needed to prove
quite a few metatheoretic properties to get there, so we declare only partial
victory on Goal 1 from \Cref{sec:problem}.
For obvious reasons, it seems preferable to stick to a simpler call-by-name
semantics without a heap if the property in question (\eg, deadness) can be
understood there as well.

Still, with \Cref{defn:deadness3} we were at least able to break
down the proof into manageable intermediate steps.
That is a huge step forward compared to the operational deadness definition of
\Cref{defn:deadness2} where we weren't even able to come up with a suitable
correctness relation.

In hindsight, we could trace back the intermediate steps to come up with at
least one proof strategy with \Cref{defn:deadness2}:
The structural induction principle is an important enabling factor and
the focus on maximal traces in \Cref{fig:semvan-correctness} suggests that
we should likely strive for a correctness relation characterising a property of
maximal traces.
This was not obvious to us when we first set out to do the proof; the gap was
too large to see how to get to the other side due to the structural mismatch.
A nice consequence of successfully avoiding structural mismatch, which we set
out to in Goal 4.

\subsection{Improvement}

Proving that dead bindings can be soundly rewritten is a nice litmus test
for the semantics.
But does it really make the program faster, or at least not slower?

We can affirm that indirectly:
A diverging program $\mathit{loop}$ takes more steps than a stuck program
$\mathit{panic}$, hence the former runs ``slower'' than the latter.
The stuck and the diverging program are not semantically equivalent,
but $\Let{x}{\mathit{panic}}{\pe}$ is semantically equivalent to
$\Let{x}{\mathit{loop}}{\pe}$ when $x$ is dead in $\pe$.
Since $(\betastep)$ runs sub-programs to completion, we would observe
execution of ${\mathit{panic}}$ or ${\mathit{loop}}$, which is the only
way in which we could have made the program slower or faster.
Since there is no semantic difference, the performance of the program must be
unaffected.

This argument is quite vague.
In order to put it on firm ground, we define an \emph{improvement relation}
$(\faster)$ in the style of \citet{MoranSands:99} in \Cref{fig:improv}.

\begin{figure}
\[\begin{array}{c}
 \ruleform{ A ⊦_n τ_1 \lesssim τ_2 \qquad μ_1 \lessapprox μ_2 \qquad d_1 \faster d_2 }
 \\
 \\[-0.5em]
 \inferrule*[right=\implrcons]
    {\later (A ⊦_n τ_1 \lesssim τ_2)}
    {A ⊦_{n} \wild \cons τ_1 \lesssim \wild \cons τ_2}
 \quad
 \inferrule*[right=\imprcons]
    {A ⊦_{n+1} τ_1 \lesssim τ_2}
    {A ⊦_{n} τ_1 \lesssim \wild \cons τ_2}
 \quad
 \inferrule*[right=\implcons]
    {A ⊦_{n} τ_1 \lesssim τ_2}
    {A ⊦_{n+1} \wild \cons τ_1 \lesssim τ_2}
 \\
 \\[-0.5em]
 \inferrule*[right=\impstuck]
    {\quad}
    {A ⊦_{0} \stuckend{} \lesssim \stuckend{}}
 \quad
 \inferrule*[right=\impcon]
    {\many{A ⊦_{n} μ_1(\pa_1) \lesssim μ_2(\pa_2)})}
    {A ⊦_{\Sigma \{\many{n}\}} \goodend{\ConV(K, \many{\pa_1}), μ_1} \lesssim \goodend{\ConV(K, \many{\pa_2}), μ_2}}
 \\
 \\[-0.5em]
 \inferrule*[right=\impfun]
    {\forall \pa.\ \pa ∈ A ⟹  A ⊦_{n} f_1(\pa)(μ_1) \lesssim f_2(\pa)(μ_2)}
    {A ⊦_{n} \goodend{\FunV(f_1), μ_1} \lesssim \goodend{\FunV(f_2), μ_2}}
 \\
 \\[-0.5em]
 \inferrule*[right=\impheap]
    {\dom(μ_1) = \dom(μ_2) \quad \forall \pa.\ \later(\dom(μ_1) ⊦_{0} μ_1(\pa)(μ_1) \lesssim μ_2(\pa)(μ_2))}
    {μ_1 \lessapprox μ_2}
 \\
 \\[-0.5em]
 \inferrule*[right=\impdenot]
    {\forall μ_1,μ_2.\ μ_1 \lessapprox μ_2 \wedge  \dom(μ_1) ⊦ d_1,d_2 ⟹  \dom(μ_1) ⊦_{0} d_1(μ_1) \lesssim d_2(μ_2)}
    {d_1 \faster d_2}
\end{array}\]
\caption{Improvement relation}
  \label{fig:improv}
\end{figure}

Structurally, $(\faster)$ is very similar to $(\equiv)$; the main differences are in
the rules for $(\cons)$ and the resulting tracking of \emph{skew credits} $n∈ℕ$,
\eg, we count the applications of $\imprcons$ to spend them on $\implcons$ or
when a value is further scrutinised.
Naturally, it is easier to prove $A ⊦_n τ_1 \lesssim τ_2$ the more credits we
have at our expense and thus the larger $n$ is.

We write $d_1 \lockstep d_2$ when $d_1 \faster d_2$ and $d_2 \faster d_1$, in
which case both denotations operate in lockstep.
Already it is the case that $d_1 \faster d_2$ implies $d_1 \equiv d_2$,
so $(\faster)$ corresponds to the strong notion of improvement in
\citet{MoranSands:99}.
The weaker notion can be recovered by defining $\imprcons$ and $\implcons$ by
coinduction, thus accepting skew credits in $ℕ_ω$ instead of $ℕ$.

We conjecture that $(\faster)$ is a sub-relation of the strong contextual
improvement relation of \citet{MoranSands:99}, just as $(\equiv)$ is finer than
contextual equivalence.

We could now once again refine our notion of deadness, using lockstep
simulation.
It is then easy to see that $\semusg{\wild}$ is correct \wrt to this stronger
notion of deadness, because we can in large parts reuse the proof for
\Cref{thm:semusg-correct-live-3}.

%\begin{definition}[Denotational deadness, improving]
%  \label{defn:deadness4}
%  An address $\pa$ is \emph{dead} in a denotation $d$ if and only if,
%  for all $μ_1 \lessapprox\!\gtrapprox μ_2$ such that $\pa$ is dead in $\rng(μ_i)$,
%  $\dom(μ_1) ∪ \{\pa\} ⊦ d$ and $d_1,d_2$, we have
%  \[
%    \dom(μ_1) ⊦_0 d(μ_1[\pa↦d_1]) \lesssim\!\gtrsim d(μ_2[\pa↦d_2]).
%  \]
%  A variable $\px$ is \emph{dead} in an expression $\pe$ if and only if
%  any $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\pa]}$ for any $ρ$ such
%  that $\pa \not∈ \rng(ρ)$.
%  Otherwise, $\px$ is \emph{live}.
%\end{definition}
%
%And we will now assume that we have proven $\semusg{\wild}$ correct \wrt to this
%new notion of deadness:
%\begin{theorem}[$\semusg{\wild}$ is an improving deadness analysis]
%  \label{thm:semusg-correct-live-4}
%  Let $\pe$ be an expression, $\px$ a variable and $\tr$ a usage environment.
%  If $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$
%  then $\px$ is dead in $\pe$.
%\end{theorem}
%
%The proof is much the same as \Cref{thm:semusg-correct-live-3}, because
%intuitively, any derivation of $A ⊦ τ_1 \sim τ_2$ can be rewritten to never use
%$\eqlcons$ and $\eqrcons$.
%Such a derivation can be directly transformed into a proof for
%$A ⊦_0 τ_1 \lesssim τ_2$, as we will never need $\implcons$ and $\imprcons$
%and skew credits remain at $0$.

\subsection{Evaluation Cardinality}

Since our new semantics is able to express evaluation cardinality and thunk
update, we may add a new $\mathbf{let1}$ construct to our language that opts out
of memoisation:
\[
 \begin{array}{rcl}
  ε ∈ \Events   & ::= & ... \mid \BindOE(\px,\pa↦d) \\
  \\[-0.5em]
  \semevt{\Letn{\px}{\pe_1}{\pe_2}}_ρ(μ) & = &
    \begin{letarray}
      \text{let} & ρ' = ρ[\px ↦ \pa] \quad \text{where $\pa \not∈ \dom(μ)$} \\
                 & d_1^\later = \semevt{\pe_1}_{ρ'} \\
      \text{in}  & \BindOE(\px,\pa↦d_1^\later) \cons \semevt{\pe_2}_{ρ'}(μ[\pa ↦ \highlight{d_1^\later}])
    \end{letarray} \\
 \end{array}
\]
Any program in which we switch from memoised $\mathbf{let}$ to $\mathbf{let1}$
is semantically equivalent after we adjust the definition of lazy heaps
accordingly.
This is a simple consequence of the fact that $\memo(\pa,d) \equiv d$
and compositionality.

However, omitting thunk memoisation has measurable effect on performance
if the same variable is evaluated repeatedly!
We should rather show that whenever $x$ is \emph{evaluated at most
once}, it is an improvement to rewrite $\Let{x}{\pe_1}{\pe_2}$ to
$\Letn{x}{\pe_1}{\pe_2}$.

We can sharpen this statement by making use of \emph{tick algebra}
\citep{MoranSands:99}.
For that, we need to add a notion of ticks to
our language (postfix, to mirror $\memo$), a routine extension:
\[
 \begin{array}{rcl}
  ε ∈ \Events   & ::= & ... \mid \TickE \\
  \\[-0.5em]
  \semevt{\pe \tick}_ρ(μ) & = & \semevt{\pe}_{ρ}(μ) \betastep \fn{v}{\fn{μ}{\TickE \cons \goodend{v,μ}}} \\
 \end{array}
\]
Whenever $x$ is ``evaluated at most once'', we
have $\semevt{\Let{x}{\pe_1}{\pe_2}}_ρ \lockstep
      \semevt{\Letn{x}{\pe_1\tick}{\pe_2}}_ρ$.
In \Cref{sec:problem}, specifically \Cref{thm:semusg-correct-2}, we have
proclaimed that $x$ is evaluated at most once whenever
$\semusg{\pe_2}_{\tr_Δ}(x) ⊑ 1$.
We can now make good on that claim:

\begin{toappendix}
\begin{figure}
\[\begin{array}{c}
 \ruleform{ \correct_L(τ_1,τ_2) }
 \\
 \\[-0.5em]
 \inferrule*[right=\corstuck]
    {\quad}
    {\correct_L(\stuckend{},\stuckend{})}
 \quad
 \inferrule*[right=\corcons]
    {\later (\correct_L(τ_1,τ_2))}
    {\correct_L(\wild :: τ_1,\wild :: τ_2)}
 \\
 \\[-0.5em]
 \inferrule*[right=\corfun]
    {\dom(μ_1) = \dom(μ_2) \quad \forall \pa ∈ (\dom(μ_i) \setminus L).\ \correct_L(f_1(\pa)(μ_1), f_2(\pa)(μ_2))}
    {\correct_L(\goodend{\FunV(f_1),μ_1},\goodend{\FunV(f_2),μ_2})}
 \\
 \\[-0.5em]
\end{array}\]
\caption{Correctness relation for \Cref{thm:semusg-by-name}}
  \label{fig:semusg-correct}
\end{figure}

\begin{lemma}
  \label{thm:pe1-dead}
  If $ω*\tr(\px) \not⊑ \semusg{\Let{\px}{\pe_1}{\pe_2}}_{\tr}$, then $\px$ is
  dead in either $\pe_1$ or $\pe_2$.
\end{lemma}
\begin{proof}
  Unfold $\semusg{\wild}$ once and consider the case that $\px$ is not dead in $\pe_1$,
  so we have $\tr(\px) ⊑ \semusg{\pe_1}_{\tr}$.

  We have
  $ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1}$ where
  $\tr_1 \triangleq \fix(\fn{\tr_1}{\tr ⊔ [\px ↦ [\px↦1]+\semusg{\pe_1}_{\tr_1}]})$.

  Clearly, $\tr_1(\px) = ω$, so
  $\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1}$, so $\px$ must be dead in $\pe_2$.
\end{proof}
\end{toappendix}

\begin{theoremrep}[Update avoidance for $\semusg{\wild}$]
  \label{thm:semusg-by-name}
  Let $\Let{\px}{\pe_1}{\pe_2}$ be an expression
  such that \\
  ${\semusg{\Let{\px}{\pe_1}{\pe_2}}_{\tr_Δ}(\px) ⊑ 1}$.
  Then
    $\semevt{\Let{\px}{\pe_1}{\pe_2}}_ρ \lockstep
     \semevt{\Letn{\px}{\pe_1\tick}{\pe_2}}_ρ$.
\end{theoremrep}
\begin{proof}
  Unless explicitly stated otherwise, we will always apply the improvement
  judgments in a symmetrical manner.
  That is, whenever we have to prove $a ⊑ b$, the proof should also hold for
  $b ⊑ a$ (where $(⊑)$ is either of $(\faster),(\lessapprox),(\lesssim)$).

  By \Cref{thm:pe1-dead}, we assume that $\px$ is dead in $\pe_1$.

  We prove $(\lockstep)$ by rule $\impdenot$.
  After unfolding the definitions of $\semevt{\wild}$ for $\mathbf{let}$ and
  $\mathbf{let1}$, the goal is to show
  \[
    \dom(μ_i) ⊦_0 \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_1]) \lesssim\!\gtrsim \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  where $\pa \not∈\dom(μ_i)$,
  $\dom(μ_i) ∪ \{\pa\} ⊦ \semevt{\pe_2}_{ρ[\px↦\pa]}$,
  $μ_1 \lessapprox\!\gtrapprox μ_2$.
  Clearly,
  \[
    \dom(μ_i) ⊦_0 \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_2]) \lesssim\!\gtrsim \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  holds by reflexivity because $μ_1[\pa↦d_2] \lessapprox\!\gtrapprox μ_2[\pa↦d_2]$, so the goal becomes
  \[
    \dom(μ_i) ⊦_0 τ_1 \lesssim\!\gtrsim τ_2,
  \]
  abbreviating $τ_i \triangleq \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_i])$.

  \noindent
  We will prove the correctness predicate $\correct_{\{\pa\}}(τ_1,τ_2)$ instead, where
  $\correct$ is defined in \Cref{fig:semusg-correct}.

  Since $\pa \not ∈ \dom(μ_1)$,
  $\corfun$ implies $\impfun$ on $\dom(μ_i)$ and the goal follows.

  \begin{definition}
    $d$ is \emph{$L$-once} if and only if, for all $μ$ such that $\rng(μ)$ is
    $L$-once, $L$ is dead in $μ(\dom(μ) \setminus L)$ and for all $\pa ∈ L$ such
    that $\pa$ is dead in $d'$,
    \[
      \correct_{L}(d(μ[\pa↦ d'\tick]), d(μ[\pa↦\memo(\pa,d')])).
    \]
    (Where $(d'\tick )(μ) \triangleq d'(μ) \betastep \fn{v}{\fn{μ}{\TickE \cons \goodend{v,μ}}}$.)
  \end{definition}

  We generalise our assumption about $\semusg{\wild}$ as follows:
  There exists a $\tr$ (\ie, $\tr_Δ$) such that
  $ω*\tr(\px) \not⊑ \semusg{\Let{\px}{\pe_1}{\pe_2}}_{\tr}$.

  Then
  $ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1}$ where
  $\tr_1 \triangleq \fix(\fn{\tr_1}{\tr ⊔ [\px ↦ [\px↦1]+\semusg{\pe_1}_{\tr_1}]})$.
  Let us also abbreviate $ρ_1 \triangleq ρ[\px↦\pa]$.

  We show that $\semevt{\pe_2}_{ρ[\px↦\pa]}$ is $\{\pa\}$-once
  assuming that $ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1}$.
  By induction on $\pe_2$, generalising to $L$-onceness and
  maintaining that $\tr_1(\px) \not⊑ \tr_1(\py) \Longleftrightarrow ρ(\py) \not∈ L$
  for all $\py∈ \dom(ρ)$.
  \begin{itemize}
    \item \textbf{Case $\pe_2 = \py$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$,
      we need to show that
      \[
        \correct_{L}(μ_1(ρ(\py))(μ_1), μ_2(ρ(\py))(μ_2)).
      \]
      where $μ_1 \triangleq μ[\pa'↦d'\tick ], μ_2 = μ[\pa'↦\memo(\pa',d')]$.
      This is easy to see when $ρ(\py) \not= \pa'$, so assume $ρ(\py) = \pa'$:
      \[
        \correct_{L}(d'(μ_1) \cons \TickE, d'(μ_2) \betastep \fn{v}{(\fn{μ'}{\UpdateE(...) \cons \goodend{v,μ'[\pa'↦\memo(\pa',\ret(v))]}})}).
      \]
      We can strip away the trailing transition, leaving behind just the heap update.

      Now, without loss of generality, we will assume that $L$ is dead in
      $\rng(μ)$.
      If that was not the case, we could apply \Cref{heap-partitioning}
      to hide all entries in which $L$ is live ``inside $d'$'' and allocate them
      on first execution.
      \sg{TODO: Turn into lemma. Sounds useful}

      When $L$ is dead in $\rng(μ)$, we can rewrite the entry for $\pa'$ freely
      without affecting $\correct$.
      In the interesting case we have $\bigstep{d'}{μ_i}{\FunV(f_i)}{μ_i'}$.
      Because of deadness, we must have
      \[
        \correct_{L}(d'(μ_1), d'(μ_2)).
      \]
      That implies
      \[
        \correct_{L}(f_1(\pa_a)(μ_1'), f_2(\pa_a)(μ_2')).
      \]
      for all $\pa_a ∈ \dom(μ_i') \setminus L$.
      Now it suffices to show the situation after heap update
      \begin{equation}
        \label{eqn:usg-var-goal}
        \correct_{L}(f_2(\pa_a)(μ_2'), f_2(\pa_a)(μ_2'[\pa'↦\memo(\pa',\ret(\FunV(f_2)))])).
      \end{equation}
      In particular, note that
      $μ_2 \forcesto μ_3 \triangleq μ[\pa'↦\memo(\pa',\ret(\FunV(f_2)))]$
      (again, we can properly hide any free address that $f_2$ needs in
      $μ_3(\pa')$), so $\bigstep{d'}{μ_3}{\FunV(f_2)}{μ_3'}$ with
      $μ_2' \forcesto μ_3'$ by the Postpone property.
      By deadness we can follow
      \[
        \correct_{L}(d'(μ_2), d'(μ_3)).
      \]
      and since $\bigstep{d'}{μ_3}{\FunV(f_2)}{μ_3'}$ (NB: $f_2$ due to the
      forcing relationship), that implies
      \[
        \correct_{L}(f_2(\pa_a)(μ_2'), f_2(\pa_a)(μ_3')).
      \]
      for all $\pa_a ∈ \dom(μ_i') \setminus L$.

      Due to forcing, it must be that $μ_3'(\pa) = μ_3(\pa)$.
      Again by forcing, $μ_2'(\pa)$ must be either
      $μ_2(\pa)$ or $μ_3'(\pa)$.

      Since the number of steps taken for $f_2(\pa_a)(μ_2'[\pa↦μ_3'(\pa)])$ must be between $f_2(\pa_a)(μ_2')$
      and $f_2(\pa_a)(μ_3')$ (due to forcing), this shows the goal \Cref{eqn:usg-var-goal}.

    \item \textbf{Case $\pe_2 = \pe~\py$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$,
      we need to show that
      \[
        \correct_{L}(\semevt{\pe~\py}_{ρ_1}(μ[\pa'↦ d'\tick]), \semevt{\pe~\py}_{ρ_1}(μ[\pa'↦\memo(\pa',d')])).
      \]

      From $ω*\tr_1(\px) \not⊑ \semusg{\pe}_{\tr_1} + ω*\tr_1(\py)$ we can see that
      $ω*\tr_1(\px) \not⊑ \semusg{\pe}_{\tr_1}$ and $\tr_1(\px) \not⊑ \tr_1(\py)$ by
      monotonicity of $+$ and $*$.
      By induction, we know that the correctness statement holds for
      $\semevt{\pe}_{ρ_1}$.
      We also know that $ρ(\py) \not∈ L$ because $\tr_1(\px) \not⊑ \tr_1(\py)$.

      In the interesting case that $\bigstep{\semevt{\pe}_{ρ_1}}{μ[\pa'↦...]}{\FunV(f_i)}{μ_i'}$,
      we have
      \[
        \correct_{L}(f_1(ρ(\py))(μ_1), f_2(ρ(\py))(μ_2))
      \]
      for all $\pa' ∈ L$, because $ρ(\py) \not∈ L$.
      This shows the goal.

    \item \textbf{Case $\pe_2 = \Lam{\py}{\pe}$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$.
      To apply $\corfun$, we need to show that
      \[
        \correct_{L}(\semevt{\pe}_{ρ_1[\py↦\pa_a]}(μ[\pa'↦ d'\tick]), \semevt{\pe}_{ρ_1[\py↦\pa_a]}(μ[\pa'↦\memo(\pa,d')]))
      \]
      for all $\pa_a ∈ (\dom(μ) \setminus L)$.

      Since $\pa_a \not∈ L$ we maintain the invariant on $ρ_1[\py↦\pa_a]$ and
      $\tr_1(\px) \not⊑ \bot = \tr_1[\py↦\bot](\py)$ and may apply the induction hypothesis
      to the above situation since $ω*\tr_1[\py↦\bot](\px) \not⊑ \semusg{\pe}_{\tr_1[\py↦⊥]}$.
      This shows the goal.

    \item \textbf{Case $\pe_2 = \Let{\py}{\pe_1'}{\pe_2'}$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$.
      We need to show that
      \[
        \correct_{L}(\semevt{\Let{\py}{\pe_1'}{\pe_2'}}_{ρ_1}(μ[\pa'↦ d'\tick]), \semevt{\Let{\py}{\pe_1'}{\pe_2'}}_{ρ_1}(μ[\pa'↦\memo(\pa,d')])).
      \]
      We unfold the definition of $\semevt{\wild}$ and see that we need to prove
      \[
        \correct_{L}(\semevt{\pe_2'}_{ρ_2}(μ[\pa'↦ d'\tick][\pa_l↦d_1]), \semevt{\pe_2'}_{ρ_2}(μ[\pa'↦\memo(\pa,d')][\pa_l↦d_1])),
      \]
      where $ρ_2 \triangleq ρ_1[\py↦\pa_l]$,
      $d_1 \triangleq \memo(\pa_l,\semevt{\pe_1'}_{ρ_1[\py↦\pa_l]})$.

      From $\px \not= \py$ (otherwise shadowing) we see that
      $\tr_1(\px) = \tr_2(\px)$, \\
      where
      ${\tr_2 \triangleq \fix(\fn{\tr_2}{\tr_1 ⊔ [\py ↦
      [\py↦1]+\semusg{\pe_1'}_{\tr_2}]})}$.
      It is clear that $ω*\tr_2(\px) = ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1} = \semusg{\pe_2'}_{\tr_2}$,
      so we want try to apply the induction hypothesis to this situation,
      but that requires us to show that the invariant on $L$ is satisfied
      as well as that $d_1$ is $L$-once.

      We proceed by cases over $\tr_1(\px) = \tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$.
      \begin{itemize}
        \item \textbf{Case $ω*\tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $ω*\tr_2(\px) ⊑ \tr_2(\py) \not⊑ \semusg{\pe_2'}_{\tr_2}$ and
          hence $\py$ is dead in $\pe_2'$, which allows us to rewrite its bindings
          in $μ$ with something that is dead in $L$.
          (It is easy to see that deadness is compatible with $\correct$ in this
          way.)
          That again makes it possible to apply the induction hypothesis
          (noting that now $\tr(\px) \not⊑ \tr_2(\py)$ and hence $\pa_l \not∈ L$),
          showing the goal.
        \item \textbf{Case $\tr_2(\px) \not⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $\px$ is dead in $\pe_1$, $\tr_2(\px) \not⊑  \tr_2(\py)$.
          This implies that $L$ is dead in $\semevt{\pe_1'}_{ρ_2}$:
          For any $\pa'$, either there exists $\py$ such that $\pa' = ρ(\py)$
          in which case $\tr_2(\px) ⊑  \tr_2(\py)$ leads to a contradiction.
          Otherwise, there is no variable in scope that refers to $\pa'$ and hence
          $\pa'$ is dead in $\semevt{\pe_1'}_{ρ_2}$ by \Cref{thm:addr-dom-sem}.

          From $\tr_2(\px) \not⊑ \tr_2(\py)$ we conclude $ρ_2(\py) = \pa_l
          \not∈L$ and $L$ is compatible with the latter inequality.
          $L$-deadness implies that $d_1$ is $L$-once as well.
          Hence we may apply the induction hypothesis to show the goal.
        \item \textbf{Case $\tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $\tr_2(\px) ⊑ \tr_2(\py)$ and hence
          $ω*\tr_2(\py) \not⊑ \semusg{\pe_2}_{\tr_2}$.

          To apply the induction hypothesis, we need to show that $μ$ is also
          $L'$-once, where $L' \triangleq L ∪ \{\pa_l\}$.
          Since $\pa_l$ is dead in $\rng(\pa_l)$, that is the case.
          Furthermore, we need to show that $\semevt{\pe_1'}_{ρ_2}$ is
          $L'$-once, but that follows by the induction hypothesis applied
          to $L'$ and $ω*\tr_2(\px) ⊑ \semusg{\pe_1}_{\tr_2}$.

          So it is the case that $\rng(μ[\pa_l↦\semevt{\pe_1'}_{ρ_2}])$ is
          $L'$-once.
          (Concerns about definedness can be overcome with
          \Cref{thm:heap-partitioning}.)
          Hence apply the induction hypothesis.

          We still need to show that we can weaken $L'$ back to $L$.
          Since $L'$ was extended for $\pa_l$ which is free in $\dom(μ_i)$,
          all rule applications can be rewritten without conflict.
      \end{itemize}
  \end{itemize}
\end{proof}

But $\semusg{\Let{x}{\pe_1}{\pe_2}}_{\tr_Δ}(x) ⊑ 1$ is just a sufficient condition for
the semantic property of ``evaluates $x$ at most once''; it is not a suitable
\emph{definition} of that property by far.
For example, $((\Lam{y}{x})~x)$ evaluates $x$ at most once, but is not recognised
as such by $\semusg{\wild}$.

Intuitively, we need a function $\mathit{count}_\pa : \Traces \to ℕ_ω$ that counts
$\LookupE(\pa)$ actions at a particular address $\pa$ over the course of a
head-normal form reduction and take the upper bound of this function in
arbitrary evaluation contexts.

We distribute these reponsibilities between the two functions $\usg$ and $\ctx$
in \Cref{fig:usg-abs}:

%Then, ``$\pa$ is evaluated at most once'' roughly corresponds to
%$\mathit{count}_\pa(\semevt{\pE[\pe_2]}_{[\px↦\pa]}([\pa↦\semevt{\pe_1}_{[\px↦\pa]}])) \leq 1$
%in arbitrary contexts such that $\pE$ does not capture $\px$ nor preoccupies $\pa$.

%This sketch has two flaws:
%The first is that the proposition and thus $\mathit{count}$ needs to know the
%address it should count, so we were forced to unfold the definition of
%$\semevt{\Let{\px}{\pe_1}{\pe_2}}_ρ(μ)$ without knowing $μ$, leading to new side
%conditions begging for an intricate definition, such as ``$\pE$ preoccupies
%$\pa$''.
%The second flaw is that $\pe_1$ can't have any free variables besides $\px$ this
%way, so it is not a faithful model of $\mathbf{let}$-binding and perhaps too
%weak to prove lockstep bisimilarity.

%Both flaws are a result of the need to escape and re-enter the syntactic (or,
%perhaps \emph{static}) realm of $\pE$ and $\pe_2$ to name the semantic (or
%\emph{dynamic}) address which the proposition needs to refer to.

%One solution to this problem is to extend the semantics function to evaluation
%contexts, with functionality
%$\semevt{\pE} : ((\Var \to \Addresses) \to \EventD) \to ((\Var \to \Addresses) \to \EventD)$
%such that $\semevt{\pE[\pe]}_ρ = \semevt{\pE}_ρ(\semevt{\pe})$.
%This equation has a solution because of compositionality
%and would allow for a faithful model of $\mathbf{let}$-binding in the hole of
%the context.
%A closed definition can be found in \Cref{fig:semevt-context}.

\begin{figure}
\[\begin{array}{c}
 \arraycolsep=3pt
 \begin{array}{rclcl@{\quad}rclcl}
  μ & ∈ & \Heaps^{\Look} & =   & \Addresses \pfun \later\Domain{\Look}
  &
  d & ∈ & \Domain{\Look} & =   & \Heaps^{\Look} \to \LookTraces \\
  u & ∈ & \Usg & =   & \{ 0 ⊏ 1 ⊏ ω \} ⊂ ℕ_ω
  &
  τ & ∈ & \LookTraces & ::=  & (l ∈ \Addresses \to \Usg) \lcons \someend{v,μ} \\
  \\[-0.75em]
 \end{array} \\
 \begin{array}{rclcl}
  v & ∈ & \Values{\Look} & ::=   & \FunV(f ∈ \Addresses \to \Domain{\Look}) \\
 \end{array} \\
 \\[-0.5em]
 \begin{array}{lcl}
  \multicolumn{3}{c}{ \ruleform{ \usg_{\Events} : \Events \to (\Addresses \to \Usg) \quad \usg_{\Traces} : \Traces \to \LookTraces } } \\
  \\[-0.5em]
  \usg_{\Events}(ε) & = & \begin{cases}
      [\pa↦1] & ε = \LookupT(\pa) \\
      \constfn{0} & \text{otherwise}
    \end{cases} \\
  l_1 +_1 (l_2 \lcons \someend{\tilde{v},\tm}) & = & (l_1+l_2) \lcons \someend{\tilde{v},\tm} \\
  \usg_{\Traces}(ε \cons τ) & = & \usg_{\Events}(ε) +_1 \usg_{\Traces}(τ) \\
  \usg_{\Traces}(\goodend{\FunV(f),μ}) & = & \constfn{0} \lcons \someend{\FunV(\usg_{\EventD} \circ f), \usg_\Heaps(μ)} \\
  \usg_{\Traces}(\stuckend{}) & = & \constfn{0} \lcons \someend{\bot_{\Values{\UsgD}}, (\constfn{\bot_\EventD}) \circ μ} \\
  \usg_{\Heaps}(μ) & = & \usg_\EventD \circ μ \\
  \usg^{⊣}_{\Heaps}(\tm) & = & \bigcup \{ μ \mid \usg_{\Heaps}(μ) ⊑ \tm \} \\
  \usg_{\EventD}(d) & = & \usg_\Traces \circ d \circ \usg^{⊣}_{\Heaps} \\
  \\[-0.5em]
 \end{array} \\
 \begin{array}{lcl}
  \multicolumn{3}{c}{ \ruleform{ \ctx_{\wild} : \poset{\Addresses} \to \LookTraces \to \Addresses \to \Usg } } \\
  \\[-0.5em]
  \ctx_A(l \lcons \someend{\FunV(\tilde{f}),\tm}) & = & l +
    \Lub_{\pa∈A} \{ ω*\ctx_A(\tilde{f}(\pa)(\tm)) \}  \\
  \\[-0.5em]
%  \multicolumn{3}{c}{ \ruleform{ α : \Traces \to \UsgD } } \\
%  \\[-0.5em]
%  α(τ) & = & fst(intra(usg_\Traces(blub(τ)(\fn{\px}{[\px↦1]}))(τ))) \\
 \end{array}
\end{array}\]
\caption{Usage abstraction}
\label{fig:usg-abs}
\end{figure}

\begin{definition}[Usage cardinality]
  \label{defn:usg-card}
  A denotation $d$ evaluates an address $\pa$ \emph{at most $u$ times} (where
  $u∈\Usg$) if and only if, for all $μ$ such that $\pa$ is dead in $μ$,
  \[
    \ctx_{\dom(μ)}(\usg_\Traces(d(μ)))(\pa) ⊑ u.
  \]
  An expression $\pe$ evaluates $\px$ \emph{at most $u$ times} if and only if,
  for $\pa \not∈ \rng(ρ)$, $\semevt{\pe}_{ρ[\px↦\pa]}$ evaluates
  $\pa$ at most $u$ times.
\end{definition}

%Happily and unlike \Cref{defn:deadness3}, this definition does
%not need to relate executions of different heaps, thus it is
%a simple \emph{trace property} rather than a \emph{program
%property}~\citep{Cousot:21} (also called
%\emph{hyperproperty} by~\citet{ClarksonSchneider:10}).

The \emph{semantic usage abstraction} $\usg_\Traces : \Traces \to \LookTraces$
is the most precise usage analysis possible and is induced componentwise on
$\Traces, \Heaps,\EventD$ and $\EventV$ by the event abstraction
\[
  \usg_{\Events}(ε) = \begin{cases}
      [\pa↦1] & ε = \LookupE(\pa) \\
      \constfn{0} & \text{otherwise}
    \end{cases}.
\]
A $\LookTraces$ trace can then be folded by $\ctx_\LookTraces$ into
an $\Addresses \to \Usg$ mapping.%
\footnote{It is worth noting that for brevity we play fast and loose with guardedness
conditions for $\LookTraces$.
I.e., $\Let{loop}{\Let{\px}{\ttrue}{loop}}{loop}$ generates a diverging trace
for which $\usg_\Traces$ would only produce an $\Addresses \to \Usg$ mapping
after an infinite amount of time. To make that formal each event should
emit its own $l$ in a guarded fashion.}
Thus, $\ctx_\LookTraces$ continues a $\LookTraces$ in all possible evaluation
contexts, returning the least upper bound of all continued traces.

\begin{toappendix}
\begin{figure}
\[\begin{array}{c}
 \ruleform{ \correct_L(τ_1,τ_2) }
 \\
 \\[-0.5em]
 \inferrule*[right=\corstuck]
    {\quad}
    {\correct_L(\stuckend{},\stuckend{})}
 \quad
 \inferrule*[right=\corcons]
    {\later (\correct_L(τ_1,τ_2))}
    {\correct_L(\wild :: τ_1,\wild :: τ_2)}
 \\
 \\[-0.5em]
 \inferrule*[right=\corfun]
    {\dom(μ_1) = \dom(μ_2) \quad \forall \pa ∈ (\dom(μ_i) \setminus L).\ \correct_L(f_1(\pa)(μ_1), f_2(\pa)(μ_2))}
    {\correct_L(\goodend{\FunV(f_1),μ_1},\goodend{\FunV(f_2),μ_2})}
 \\
 \\[-0.5em]
\end{array}\]
\caption{Correctness relation for \Cref{thm:usg-by-name}}
  \label{fig:semusg-correct2}
\end{figure}
\end{toappendix}

%Rather than to let syntactic evaluation contexts dictate how $\pe_2$ might be
%evaluated to produce (essentially first-order) traces that we count
%$\LookupE(\pa)$ actions in, $\usg$ lifts the counting of addresses through the
%whole domain, including function values.

%\begin{lemma}[Heap extension preserves improvement]
%  If $A ⊦_0 d_1(μ_1) \lesssim d_2(μ_2)$, then $A ⊦_0 d_1(μ_1[\pa↦d_1]) \lesssim d_2(μ_2[\pa↦d_2])$.
%\end{lemma}

\begin{theoremrep}[Update avoidance]
  \label{thm:usg-by-name}
  Let $\Let{\px}{\pe_1}{\pe_2}$ be an expression such that $\pe_2$ evaluates $\px$
  at most once and $\px$ is dead in $\pe_1$.
  Then
    $\semevt{\Let{\px}{\pe_1}{\pe_2}}_ρ \lockstep
     \semevt{\Letn{\px}{\pe_1\tick}{\pe_2}}_ρ$.
\end{theoremrep}
\begin{proof}
  Unless explicitly stated otherwise, we will always apply the improvement
  judgments in a symmetrical manner.
  That is, whenever we have to prove $a ⊑ b$, the proof should also hold for
  $b ⊑ a$ (where $(⊑)$ is either of $(\faster),(\lessapprox),(\lesssim)$).

  By \Cref{thm:pe1-dead}, we assume that $\px$ is dead in $\pe_1$.

  We prove $(\lockstep)$ by rule $\impdenot$.
  After unfolding the definitions of $\semevt{\wild}$ for $\mathbf{let}$ and
  $\mathbf{let1}$, the goal is to show
  \[
    \dom(μ_i) ⊦_0 \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_1]) \lesssim\!\gtrsim \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  where $\pa \not∈\dom(μ_i)$,
  $\dom(μ_i) ∪ \{\pa\} ⊦ \semevt{\pe_2}_{ρ[\px↦\pa]}$,
  $μ_1 \lessapprox\!\gtrapprox μ_2$.
  Clearly,
  \[
    \dom(μ_i) ⊦_0 \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_2]) \lesssim\!\gtrsim \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_2[\pa↦d_2])
  \]
  holds by reflexivity because $μ_1[\pa↦d_2] \lessapprox\!\gtrapprox μ_2[\pa↦d_2]$, so the goal becomes
  \[
    \dom(μ_i) ⊦_0 τ_1 \lesssim\!\gtrsim τ_2,
  \]
  abbreviating $τ_i \triangleq \semevt{\pe_2}_{ρ[\px↦\pa]}(μ_1[\pa↦d_i])$.

  \noindent
  We will prove the correctness predicate $\correct_{\{\pa\}}(τ_1,τ_2)$ instead, where
  $\correct$ is defined in \Cref{fig:semusg-correct2}.

  Since $\pa \not ∈ \dom(μ_1)$,
  $\corfun$ implies $\impfun$ on $\dom(μ_i)$ and the goal follows.

  \begin{definition}
    $d$ is \emph{$L$-once} if and only if, for all $μ$ such that $\rng(μ)$ is
    $L$-once, $L$ is dead in $μ(\dom(μ) \setminus L)$ and for all $\pa ∈ L$ such
    that $\pa$ is dead in $d'$,
    \[
      \correct_{L}(d(μ[\pa↦ d'\tick]), d(μ[\pa↦\memo(\pa,d')])).
    \]
    (Where $(d'\tick )(μ) \triangleq d'(μ) \betastep \fn{v}{\fn{μ}{\TickE \cons \goodend{v,μ}}}$.)
  \end{definition}

  Since $\pe_2$ evaluates $\px$ at most once, we have
  $\ctx_\LookTraces(\usg_\Traces(τ_i))(\pa) ⊑ 1$.
  Let us also abbreviate $ρ_1 \triangleq ρ[\px↦\pa]$.

  We show that $\semevt{\pe_2}_{ρ[\px↦\pa]}$ is $\{\pa\}$-once
  assuming that $ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1}$.
  By induction on $\pe_2$, generalising to $L$-onceness and
  maintaining that $\tr_1(\px) \not⊑ \tr_1(\py) \Longleftrightarrow ρ(\py) \not∈ L$
  for all $\py∈ \dom(ρ)$.
  \begin{itemize}
    \item \textbf{Case $\pe_2 = \py$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$,
      we need to show that
      \[
        \correct_{L}(μ_1(ρ(\py))(μ_1), μ_2(ρ(\py))(μ_2)).
      \]
      where $μ_1 \triangleq μ[\pa'↦d'\tick ], μ_2 = μ[\pa'↦\memo(\pa',d')]$.
      This is easy to see when $ρ(\py) \not= \pa'$, so assume $ρ(\py) = \pa'$:
      \[
        \correct_{L}(d'(μ_1) \cons \TickE, d'(μ_2) \betastep \fn{v}{(\fn{μ'}{\UpdateE(...) \cons \goodend{v,μ'[\pa'↦\memo(\pa',\ret(v))]}})}).
      \]
      We can strip away the trailing transition, leaving behind just the heap update.

      Now, without loss of generality, we will assume that $L$ is dead in
      $\rng(μ)$.
      If that was not the case, we could apply \Cref{heap-partitioning}
      to hide all entries in which $L$ is live ``inside $d'$'' and allocate them
      on first execution.
      \sg{TODO: Turn into lemma. Sounds useful}

      When $L$ is dead in $\rng(μ)$, we can rewrite the entry for $\pa'$ freely
      without affecting $\correct$.
      In the interesting case we have $\bigstep{d'}{μ_i}{\FunV(f_i)}{μ_i'}$.
      Because of deadness, we must have
      \[
        \correct_{L}(d'(μ_1), d'(μ_2)).
      \]
      That implies
      \[
        \correct_{L}(f_1(\pa_a)(μ_1'), f_2(\pa_a)(μ_2')).
      \]
      for all $\pa_a ∈ \dom(μ_i') \setminus L$.
      Now it suffices to show the situation after heap update
      \begin{equation}
        \label{eqn:usg-var-goal}
        \correct_{L}(f_2(\pa_a)(μ_2'), f_2(\pa_a)(μ_2'[\pa'↦\memo(\pa',\ret(\FunV(f_2)))])).
      \end{equation}
      In particular, note that
      $μ_2 \forcesto μ_3 \triangleq μ[\pa'↦\memo(\pa',\ret(\FunV(f_2)))]$
      (again, we can properly hide any free address that $f_2$ needs in
      $μ_3(\pa')$), so $\bigstep{d'}{μ_3}{\FunV(f_2)}{μ_3'}$ with
      $μ_2' \forcesto μ_3'$ by the Postpone property.
      By deadness we can follow
      \[
        \correct_{L}(d'(μ_2), d'(μ_3)).
      \]
      and since $\bigstep{d'}{μ_3}{\FunV(f_2)}{μ_3'}$ (NB: $f_2$ due to the
      forcing relationship), that implies
      \[
        \correct_{L}(f_2(\pa_a)(μ_2'), f_2(\pa_a)(μ_3')).
      \]
      for all $\pa_a ∈ \dom(μ_i') \setminus L$.

      Due to forcing, it must be that $μ_3'(\pa) = μ_3(\pa)$.
      Again by forcing, $μ_2'(\pa)$ must be either
      $μ_2(\pa)$ or $μ_3'(\pa)$.

      Since the number of steps taken for $f_2(\pa_a)(μ_2'[\pa↦μ_3'(\pa)])$ must be between $f_2(\pa_a)(μ_2')$
      and $f_2(\pa_a)(μ_3')$ (due to forcing), this shows the goal \Cref{eqn:usg-var-goal}.

    \item \textbf{Case $\pe_2 = \pe~\py$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$,
      we need to show that
      \[
        \correct_{L}(\semevt{\pe~\py}_{ρ_1}(μ[\pa'↦ d'\tick]), \semevt{\pe~\py}_{ρ_1}(μ[\pa'↦\memo(\pa',d')])).
      \]

      From $ω*\tr_1(\px) \not⊑ \semusg{\pe}_{\tr_1} + ω*\tr_1(\py)$ we can see that
      $ω*\tr_1(\px) \not⊑ \semusg{\pe}_{\tr_1}$ and $\tr_1(\px) \not⊑ \tr_1(\py)$ by
      monotonicity of $+$ and $*$.
      By induction, we know that the correctness statement holds for
      $\semevt{\pe}_{ρ_1}$.
      We also know that $ρ(\py) \not∈ L$ because $\tr_1(\px) \not⊑ \tr_1(\py)$.

      In the interesting case that $\bigstep{\semevt{\pe}_{ρ_1}}{μ[\pa'↦...]}{\FunV(f_i)}{μ_i'}$,
      we have
      \[
        \correct_{L}(f_1(ρ(\py))(μ_1), f_2(ρ(\py))(μ_2))
      \]
      for all $\pa' ∈ L$, because $ρ(\py) \not∈ L$.
      This shows the goal.

    \item \textbf{Case $\pe_2 = \Lam{\py}{\pe}$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$.
      To apply $\corfun$, we need to show that
      \[
        \correct_{L}(\semevt{\pe}_{ρ_1[\py↦\pa_a]}(μ[\pa'↦ d'\tick]), \semevt{\pe}_{ρ_1[\py↦\pa_a]}(μ[\pa'↦\memo(\pa,d')]))
      \]
      for all $\pa_a ∈ (\dom(μ) \setminus L)$.

      Since $\pa_a \not∈ L$ we maintain the invariant on $ρ_1[\py↦\pa_a]$ and
      $\tr_1(\px) \not⊑ \bot = \tr_1[\py↦\bot](\py)$ and may apply the induction hypothesis
      to the above situation since $ω*\tr_1[\py↦\bot](\px) \not⊑ \semusg{\pe}_{\tr_1[\py↦⊥]}$.
      This shows the goal.

    \item \textbf{Case $\pe_2 = \Let{\py}{\pe_1'}{\pe_2'}$}:
      Fix $μ$ such that $\rng(μ)$ is $L$-once and for all $\pa' ∈ L$ such that $\pa'$ is dead in $d'$.
      We need to show that
      \[
        \correct_{L}(\semevt{\Let{\py}{\pe_1'}{\pe_2'}}_{ρ_1}(μ[\pa'↦ d'\tick]), \semevt{\Let{\py}{\pe_1'}{\pe_2'}}_{ρ_1}(μ[\pa'↦\memo(\pa,d')])).
      \]
      We unfold the definition of $\semevt{\wild}$ and see that we need to prove
      \[
        \correct_{L}(\semevt{\pe_2'}_{ρ_2}(μ[\pa'↦ d'\tick][\pa_l↦d_1]), \semevt{\pe_2'}_{ρ_2}(μ[\pa'↦\memo(\pa,d')][\pa_l↦d_1])),
      \]
      where $ρ_2 \triangleq ρ_1[\py↦\pa_l]$,
      $d_1 \triangleq \memo(\pa_l,\semevt{\pe_1'}_{ρ_1[\py↦\pa_l]})$.

      From $\px \not= \py$ (otherwise shadowing) we see that
      $\tr_1(\px) = \tr_2(\px)$, \\
      where
      ${\tr_2 \triangleq \fix(\fn{\tr_2}{\tr_1 ⊔ [\py ↦
      [\py↦1]+\semusg{\pe_1'}_{\tr_2}]})}$.
      It is clear that $ω*\tr_2(\px) = ω*\tr_1(\px) \not⊑ \semusg{\pe_2}_{\tr_1} = \semusg{\pe_2'}_{\tr_2}$,
      so we want try to apply the induction hypothesis to this situation,
      but that requires us to show that the invariant on $L$ is satisfied
      as well as that $d_1$ is $L$-once.

      We proceed by cases over $\tr_1(\px) = \tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$.
      \begin{itemize}
        \item \textbf{Case $ω*\tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $ω*\tr_2(\px) ⊑ \tr_2(\py) \not⊑ \semusg{\pe_2'}_{\tr_2}$ and
          hence $\py$ is dead in $\pe_2'$, which allows us to rewrite its bindings
          in $μ$ with something that is dead in $L$.
          (It is easy to see that deadness is compatible with $\correct$ in this
          way.)
          That again makes it possible to apply the induction hypothesis
          (noting that now $\tr(\px) \not⊑ \tr_2(\py)$ and hence $\pa_l \not∈ L$),
          showing the goal.
        \item \textbf{Case $\tr_2(\px) \not⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $\px$ is dead in $\pe_1$, $\tr_2(\px) \not⊑  \tr_2(\py)$.
          This implies that $L$ is dead in $\semevt{\pe_1'}_{ρ_2}$:
          For any $\pa'$, either there exists $\py$ such that $\pa' = ρ(\py)$
          in which case $\tr_2(\px) ⊑  \tr_2(\py)$ leads to a contradiction.
          Otherwise, there is no variable in scope that refers to $\pa'$ and hence
          $\pa'$ is dead in $\semevt{\pe_1'}_{ρ_2}$ by \Cref{thm:addr-dom-sem}.

          From $\tr_2(\px) \not⊑ \tr_2(\py)$ we conclude $ρ_2(\py) = \pa_l
          \not∈L$ and $L$ is compatible with the latter inequality.
          $L$-deadness implies that $d_1$ is $L$-once as well.
          Hence we may apply the induction hypothesis to show the goal.
        \item \textbf{Case $\tr_2(\px) ⊑ \semusg{\pe_1'}_{\tr_2}$}:
          Then $\tr_2(\px) ⊑ \tr_2(\py)$ and hence
          $ω*\tr_2(\py) \not⊑ \semusg{\pe_2}_{\tr_2}$.

          To apply the induction hypothesis, we need to show that $μ$ is also
          $L'$-once, where $L' \triangleq L ∪ \{\pa_l\}$.
          Since $\pa_l$ is dead in $\rng(\pa_l)$, that is the case.
          Furthermore, we need to show that $\semevt{\pe_1'}_{ρ_2}$ is
          $L'$-once, but that follows by the induction hypothesis applied
          to $L'$ and $ω*\tr_2(\px) ⊑ \semusg{\pe_1}_{\tr_2}$.

          So it is the case that $\rng(μ[\pa_l↦\semevt{\pe_1'}_{ρ_2}])$ is
          $L'$-once.
          (Concerns about definedness can be overcome with
          \Cref{thm:heap-partitioning}.)
          Hence apply the induction hypothesis.

          We still need to show that we can weaken $L'$ back to $L$.
          Since $L'$ was extended for $\pa_l$ which is free in $\dom(μ_i)$,
          all rule applications can be rewritten without conflict.
      \end{itemize}
  \end{itemize}
\end{proof}

Similarly, one could prove that a binding is dead when it is evaluated at most 0
times.
An alternative correctness proof for $\semusg{\wild}$ can then be formulated by
\emph{abstract interpretation}, proving it correct simultaneously as a deadness
and a sharing analysis:

\begin{theoremrep}[$\semusg{\wild}$ approximates semantic usage]
  \label{thm:semusg-correct-3}
  Let $\pe$ be an expression, $\px$ a variable, $\pa$ an address
  that is dead in a heap $μ$ and $ρ$ an environment such that $\pa \not∈
  \rng(ρ)$.
  Then
  \[
    \ctx_{\dom(μ)}(\usg_\Traces(\semevt{\pe}_ρ[\px↦\pa](μ)))(\pa) ⊑ \semusg{\pe}_{\tr_Δ}(\px)
  \]
\end{theoremrep}
\begin{proof}
  We first get rid of the concrete heap by the following estimate:
  \[
    \ctx_{\dom(μ)}(\usg_\Traces(\semevt{\pe}_ρ[\px↦\pa](μ)))(\pa) ⊑ \ctx_{\dom(μ)}(\usg_\EventD(\semevt{\pe}_ρ[\px↦\pa])(\usg_\Heaps(μ)))(\pa)
  \]
  for $A \triangleq $.
  This holds because $μ ∈ \usg^⊣_\Heaps(\usg_\Heaps(μ))$, exploiting that
  $\usg_\Heaps$ is left adjoint to $\usg^⊣_\Heaps$.

  By induction on $\pe$, we show that
  \[
    \ctx_{A}(\usg_\EventD(\semevt{\pe}_ρ)(\tm))(ρ(\px)) ⊑ \semusg{\pe}_{\tr}(\px)
  \]
  for all $\px$, maintaining the invariant that $ρ(\px)$ is dead in $\tm(A)$ and
  for all $\py$, $\tr_Δ(\py) + \ctx_A(\tm(ρ(\py)))(ρ(\py)) ⊑ \tr(\py)$.

  Initially, $A = \dom(μ), \tr = \tr_Δ$.
  We abbreviate $u_l \triangleq \ctx_{A}(\usg_\EventD(\semevt{\pe}_ρ)(\tm))(ρ(\px))$
  and $u_r = \semusg{\pe}_{\tr}(\px)$.
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then $1 ⊑ u$

  \end{itemize}
\end{proof}

A more elegant proof would continually abstract $\ctx_A \circ \usg_\Traces$
without relating to the structure of $\semevt{\wild}$ or $\semusg{\wild}$ at
all, encoding the strengthened inductive hypothesis (\ie, the logical relation)
of the proof above in a chain of Galois connections. Then the above proof
is simply by direct, structural induction on $\pe$ and equational reasoning
-- \citet{Cousot:21} calls this process ``calculational design''.
We want to attempt such a proof in the future and are confident that it will
yield insightful abstraction functions, for example encoding the transition
from heap-based call-by-need to call-by-name or the transition from
interprocedural to intraprocedural analysis.
