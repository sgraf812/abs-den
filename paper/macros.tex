% https://tex.stackexchange.com/a/543050/52414
% Unfortunately, \label[sublemma]{} is incompatible with apxproofs
%\crefalias{sublemma}{item}
%\crefname{sublemma}{lemma}{lemmas}
%\Crefname{sublemma}{Lemma}{Lemmas}

\counterwithin*{equation}{section}

% Comments and notes
\makeatletter
\newcommand\ifnonanon[1]{%
\if@ACM@anonymous
\else
  #1%
\fi
}
\makeatother
\newcommand{\slpj}[1]{\ifnonanon{\textcolor{blue}{\emph{SLPJ: #1}}}{}}
\newenvironment{slpjenv}{\em SLPJ:}{}
\newcommand{\sg}[1]{\ifnonanon{\textcolor{blue}{\emph{SG: #1}}}{}}
\newcommand{\sven}[1]{\ifnonanon{\textcolor{blue}{\emph{Sven: #1}}}{}}

% Auxiliary
\newcommand{\many}[1]{\overline{#1}}
\newcommand{\wild}{\ensuremath{\mathunderscore}}
\newcommand{\pfun}{\rightharpoonup}
\newcommand{\nelems}[1]{\lvert#1\rvert}
\newcommand{\fn}[2]{\ensuremath{λ#1.\ #2}}
%\newcommand{\fn}[2]{#1 ↦ #2}
\newcommand{\constfn}[1]{\fn{\mathunderscore}{#1}}
%\newcommand{\repeat}[2]{\foreach \n in {1,...,#1}{#2}} % https://tex.stackexchange.com/a/16190/52414
% https://tex.stackexchange.com/a/21647
\makeatletter
\newcommand{\superimpose}[3][\mathord]{#1{\mathpalette\superimpose@{{#2}{#3}}}}
\newcommand{\superimpose@}[2]{\superimpose@@{#1}#2}
\newcommand{\superimpose@@}[3]{%
  \ooalign{%
    \hfil$\m@th#1#2$\hfil\cr
    \hfil$\m@th#1#3$\hfil\cr
  }%
}
\makeatother
% Stacked operators like \lesseq, \lesssim, etc.
% https://tex.stackexchange.com/a/536604/52414
\makeatletter
\newcommand{\impsim}{\lesssim\!\gtrsim}
\newcommand{\lessequiv}{\mathrel{\raisebox{-1pt}{$\gl@over[0.25pt]{\vartriangleleft}{\sim}$}}}
\newcommand{\impequiv}{\mathrel{\raisebox{-1.25pt}{$\gl@over[0.25pt]{\superimpose{\raisebox{1.3pt}{\clipbox{0pt 3pt 0pt 3pt}{$\mid$}}}{\rotatebox[origin=c]{90}{$\lozenge$}}}{\sim}$}}}
\newcommand{\impapprox}{\lessapprox\!\gtrapprox}
\newcommand{\gl@over}[3][1pt]{%
  \vcenter{\m@th\offinterlineskip\ialign{%
    \hfil$##$\hfil\cr #2\cr \noalign{\vskip#1} #3\cr
  }}%
}
\makeatother
\newenvironment{letarray}{\begin{array}{@{}l@{\hspace{1ex}}l}}{\end{array}}
\newcommand{\later}{{\mathop{\vcenter{\hbox{$\scriptscriptstyle\blacktriangleright$}}}}}
\newcommand{\purelater}{\mathop{\mathsf{next}}}
\newcommand{\aplater}{\mathbin{\circledast}}
\newcommand{\lBrace}{{\{\hspace{-0.22em}\mid}}
\newcommand{\rBrace}{{\mid\hspace{-0.22em}\}}}
\DeclarePairedDelimiter\idiom{\lBrace}{\rBrace}
\newcommand{\formgoal}[2]{%
\vspace{0.5\baselineskip}
\noindent
\begin{minipage}{\linewidth}
\centering\fbox{\textbf{Goal #1}: \begin{varwidth}[t]{\linewidth - 9em}#2\end{varwidth}}
\end{minipage}%
\\[-0.5\baselineskip]
}
\newcommand{\pagetarget}[2]{%
  \phantomsection%
  \label{#1}%
  \hypertarget{#1}{#2}%
}

% Syntax
%% LC
\renewcommand{\Con}{\mathsf{Con}} % defined in LYG, hence renew
\renewcommand{\Var}{\mathsf{Var}} % defined in LYG, hence renew
\newcommand{\Exp}{\mathsf{Exp}}
\newcommand{\Ctx}{\mathsf{Ctx}}
\newcommand{\Val}{\mathsf{Val}}
\newcommand{\Usg}{\mathsf{Usg}}
\newcommand{\px}{\mathsf{x}}
\newcommand{\py}{\mathsf{y}}
\newcommand{\pz}{\mathsf{z}}
\newcommand{\pv}{\mathsf{v}}
\newcommand{\pe}{\mathsf{e}}
\newcommand{\pC}{\mathsf{C}}
\newcommand{\pE}{\mathsf{E}}
\newcommand{\pA}{\mathsf{A}}
\newcommand{\Lam}[2]{\mathbf{\bar{\lambdaup}} #1. #2}
\newcommand{\Let}[3]{\mathbf{let}~{#1}\nobreak=\nobreak{#2}~\mathbf{in}~{#3}}
\newcommand{\Letmany}[3]{\many{\mathbf{let}~{#1}\nobreak=\nobreak{#2}~\mathbf{in}}~{#3}}
\newcommand{\Letn}[3]{\mathbf{let1}~{#1}\nobreak=\nobreak{#2}~\mathbf{in}~{#3}}
\newcommand{\Letsmall}[3]{\mathbf{let}\,{#1}\!\!=\!\!{#2}\,\mathbf{in}\,{#3}}
\newcommand{\Case}[2]{\mathbf{case}~{#1}~\mathbf{of}~{#2}}
\newcommand{\Sel}[1][]{\many{K~\many{\px} \rightarrow \pe_{#1}}}
\newcommand{\SelArity}{\many{K~\many{\px}^{α_K} \rightarrow \pe}}
\newcommand{\hole}{\square}
\newcommand{\dom}{\mathop{\mathsf{dom}}}
\newcommand{\rng}{\mathop\mathsf{rng}}
\newcommand{\fv}{\mathop\mathsf{fv}}
\newcommand{\disjoint}{\mathbin{\#}}
\newcommand{\delvar}[1]{{\setminus_{#1}}}
\newcommand{\bool}{\mathtt{bool}}
\newcommand{\ttrue}{\mathtt{tt}}
\newcommand{\ffalse}{\mathtt{ff}}
\newcommand{\tick}{\checkmark}
\newcommand{\dead}[2]{#1 ⊦_\mathcal{D} #2}
%% Events
\newcommand{\Events}{\mathbb{Ev}}
%% Traces
\newcommand{\Traces}{\mathbb{T}}
\renewcommand{\cons}{\mathbin{::}} % defined in LYG, hence renew
\newcommand{\ctrl}{\mathit{ctrl}}
\newcommand{\cont}{\mathit{cont}}
\newcommand{\init}{\mathit{init}}
\newcommand{\pcirc}{%
  \mathchoice
    {\mathbin{\ooalign{\hidewidth$\circ$\hidewidth\cr$\rightharpoonup$}}}% \displaystyle
    {\mathbin{\ooalign{\hidewidth$\circ$\hidewidth\cr$\rightharpoonup$}}}% \textstyle
    {\mathbin{\ooalign{\hidewidth$\scriptstyle\circ$\hidewidth\cr$\scriptstyle\rightharpoonup$}}}% \scriptstyle
    {\mathbin{\ooalign{\hidewidth$\scriptscriptstyle\circ$\hidewidth\cr$\scriptscriptstyle\rightharpoonup$}}}% \scriptscriptstyle
}

%% Domains
\newcommand{\Environments}{\mathbb{E}}
\newcommand{\Heaps}{\mathbb{H}}
\newcommand{\Continuations}{\mathbb{K}}
\newcommand{\EContexts}{\mathbb{EC}}
\newcommand{\AContexts}{\mathbb{AC}}
\newcommand{\tr}{{\ensuremath{\tilde{ρ}}}}
\newcommand{\tm}{{\ensuremath{\tilde{μ}}}}
\newcommand{\ttau}{{\ensuremath{\tilde{τ}}}}
\newcommand{\tv}{{\ensuremath{\tilde{v}}}}
\newcommand{\td}{{\ensuremath{\tilde{d}}}}
\newcommand{\bigsteppn}[3]{\ensuremath{#2\!\Downarrow^{#1}\!#3}}
\newcommand{\bigstepp}[2]{\bigsteppn{}{#1}{#2}}
\newcommand{\bigstep}[4]{\ensuremath{{\langle#1,#2\rangle\!\!\Downarrow\!\!\langle#3,#4\rangle}}}
\newcommand{\bigstepn}[5]{\ensuremath{{\langle#2,#3\rangle\!\!\Downarrow^{#1}\!\!\langle#4,#5\rangle}}}
\newcommand{\progressto}{\rightsquigarrow}
\newcommand{\forcessym}{\ensuremath{\leftrightsquigarrow}}
\newcommand{\progresstorefl} {$\progressto$\textsc{-Refl}\xspace}
\newcommand{\progresstotrans}{$\progressto$\textsc{-Trans}\xspace}
\newcommand{\progresstoext}  {$\progressto$\textsc{-Ext}\xspace}
\newcommand{\progresstomemo} {$\progressto$\textsc{-Memo}\xspace}
\newcommand{\correct}{\mathcal{C}}

% Math
\newcommand{\pow}[1]{\wp(#1)}
\newcommand{\Nat}{\mathbb{N}}

% Absence
\newcommand{\Absence}{\mathsf{Absence}}
\newcommand{\Uses}{\mathsf{Uses}}
\newcommand{\Summary}{\mathsf{Summary}}
\newcommand{\sumcons}{\mathbin{\bbcolon}}
\renewcommand{\rep}[1]{\mathsf{Rep}~#1} % defined in LYG, hence renew
\newcommand{\repA}{\mathsf{Rep}~\aA}
\newcommand{\repU}{\mathsf{Rep}~\aU}
\newcommand{\both}{\mathbin{\&}}
\renewcommand{\Env}{\mathsf{Env}} % defined in LYG, hence renew
\newcommand{\aA}{\mathsf{A}}
\newcommand{\aU}{\mathrlap{\mathsf{U}}\hphantom{\aA}}
\newcommand{\AbsTy}{\mathsf{AbsTy}}
\renewcommand{\denot}[1]{\llbracket {#1} \rrbracket} % defined in LYG, hence renew
\newcommand{\semabs}[1]{\mathcal{A}\denot{#1}}
\newcommand{\semabsK}[1]{\mathcal{K}\denot{#1}}
\newcommand{\semabsS}[1]{\mathcal{C}\denot{#1}}

% Small-step
\newcommand{\Addresses}{\mathsf{Addr}}
\newcommand{\pa}{\mathsf{a}}
\newcommand{\smallstep}[1][\hspace{1.5ex}]{\xhookrightarrow{#1}}
\newcommand{\States}{\mathbb{S}}
\newcommand{\STraces}{\mathbb{S}^{\infty}}
\newcommand{\pushF}{\cdot}
\newcommand{\StopF}{\mathbf{stop}}
\newcommand{\ApplyF}{\mathbf{ap}}
\newcommand{\SelF}{\mathbf{sel}}
\newcommand{\UpdateF}{\mathbf{upd}}
\newcommand{\AppIT}{\textsc{App}_1}
\newcommand{\AppET}{\textsc{App}_2}
\newcommand{\ValueT}{\textsc{Val}}
\newcommand{\CaseIT}{\textsc{Case}_1}
\newcommand{\CaseET}{\textsc{Case}_2}
\newcommand{\LookupT}{\textsc{Look}}
\newcommand{\UpdateT}{\textsc{Upd}}
\newcommand{\BindT}{\textsc{Bind}}
\newcommand{\LetOT}{\textsc{Let}_0}
\newcommand{\LetIT}{\textsc{Let}_1}
\newcommand{\UnrollT}{\textsc{Unroll}}
\newcommand{\deep}[2]{#1\,\mathsf{deep}\,#2}
\newcommand{\interior}[1]{#1\,\mathsf{inter}}
\newcommand{\maxtrace}[1]{#1\,\mathsf{max}}
