%include custom.fmt

\renewcommand\thefigure{\thesection.\arabic{figure}}

\subsection{Proofs}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live}]
  \label{prf:semusg-correct-live}
  By induction on $\pe$.
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$,
  so we are given an arbitrary $ρ$, $d_1$ and $d_2$ and have to show that
  $\semscott{\pe}_{ρ[\px↦d_1]} = \semscott{\pe}_{ρ[\px↦d_2]}$.
  By cases on $\pe$:
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then
      $\tr(\px) \not⊑ \semusg{\py}_{\tr} = \tr(\py) = \tr(\px)$, a contradiction.
      If $\px \not= \py$, then varying the entry for $\px$ won't matter; hence
      $\px$ is dead in $\py$.
    \item \textbf{Case $\pe = \Lam{\py}{\pe'}$}: The equality follows from
      pointwise equality on functions, so we pick an arbitrary $d$ to show
      $\semscott{\pe'}_{ρ[\px↦d_1][\py↦d]} = \semscott{\pe'}_{ρ[\px↦d_2][\py↦d]}$.

      This is simple to see if $\px=\py$. Otherwise, $\tr[\py↦\bot]$ witnesses the fact that
      \[
        \tr[\py↦\bot](\px) = \tr(\px) \not⊑
        \semusg{\Lam{\py}{\pe'}}_{\tr} = \semusg{\pe'}_{\tr[\py↦\bot]}
      \]
      so we can apply the induction hypothesis to see that $\px$ must be dead in
      $\pe'$, hence the equality on $\semscott{\pe'}$ holds.
    \item \textbf{Case $\pe = \pe'~\py$}:
      From $\tr(\px) \not⊑ \semusg{\pe'}_{\tr} + ω*\tr(\py)$ we can see that
      $\tr(\px) \not⊑ \semusg{\pe'}_{\tr}$ and $\tr(\px) \not⊑ \tr(\py)$ by
      monotonicity of $+$ and $*$.
      If $\px=\py$ then the latter inequality leads to a contradiction.
      Otherwise, $\px$ must be dead in $\pe'$, hence both cases of
      $\semscott{\pe'~\py}$ evaluate equally, differing only in
      the environment. It remains to be shown that
      $ρ[\px↦d_1](\py) = ρ[\px↦d_2](\py)$, and that is easy to see since
      $\px \not= \py$.
    \item \textbf{Case $\pe = \Let{\py}{\pe_1}{\pe_2}$}:
      We have to show that
      \[
        \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
      \]
      where $d'_i$ satisfy $d'_i = \semscott{\pe_1}_{ρ[\px↦d_i][\py↦d'_i]}$.
      The case $\px = \py$ is simple to see, because $ρ[\px↦d_i](\px)$ is never
      looked at.
      So we assume $\px \not= \py$ and see that $\tr(\px) = \tr'(\px)$, where
      $\tr' = \operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦ \semusg{\pe_1}_{\tr'}]})$.

      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      So by the induction hypothesis, $\px$ is dead in $\pe_2$.

%      Now consider the predicate $P(\tr) = \tr(\px) ⊑ \semusg{\pe_1}_{\tr}$.
%      We must prove it admissable to see that it holds (by fixpoint induction)
%      for $\tr'$. That is clearly the case because it is a composition of
%      continuous functions ($\tr, \semusg{\pe_1}$) and admissable predicates
%      ($⊑$).
%
%      SG: I think we don't need to prove that P above is admissable because
%      we never try to prove it through fixpoint induction; we simply apply LEM.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite
          \[
            \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_2]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
          \]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\px$ is dead in $\pe_1$ and $d'_1 = d'_2$. The goal follows
          from the fact that $\px$ is dead in $\pe_2$.
      \end{itemize}
  \end{itemize}
\end{proof}

\begin{lemma}[Heap hiding]
  \label{thm:heap-hiding}
  Let $μ$ be a heap and $\pa ∈ \dom(μ)$ dead in $\rng(μ)$.
  Then there exists a heap $μ_h$ with domain $\dom(μ) \setminus \{ \pa \}$
  and $μ \approx μ_h[\pa↦μ(\pa)]$.
\end{lemma}
\begin{proof}
  Define $μ_h \triangleq \mathit{hide}_\pa(μ)$, where
  \[\begin{array}{rcl}
    \mathit{hide}_\pa(μ)(\pa')(μ') & = & \begin{cases}
      μ(\pa')(μ'[\pa↦μ(\pa)]) & \pa' ∈ \dom(μ) \setminus \{ \pa \} \\
    \end{cases}
  \end{array}\]
  We abbreviate $μ_h \triangleq \mathit{hide}_\pa(μ)$.
  Clearly, $\dom(μ_h) = \dom(μ) \setminus \{ \pa \}$.

  By Löb induction, we prove
  \[
    μ_h \text{ is lazy and extensional} \wedge μ \approx μ_h[\pa↦μ(\pa)]
  \]
  So we assume that the property holds later.

  Consider $d \triangleq μ_h(\pa') = \fn{μ'}{μ(\pa')(μ'[\pa↦μ(\pa)])}$ for some $\pa' ∈ \dom(μ_h)$.
  Then $d(μ_h) = μ(\pa')(μ_h[\pa↦μ(\pa)])$ which is defined, because
  $μ(\pa')(μ)$ is defined and $μ(\pa')$ is extensional, which we can apply to
  $μ \approx μ_h[\pa↦μ(\pa)]$ later.

  Furthermore, $d$ is lazy for a similar argument that the $\mathbf{let}$ case
  of \Cref{thm:semevt-lazy}.
  Extensionality follows because the heap extension $[\pa↦μ(\pa)]$ in $d$ is
  always with the same (extensional) element.

  For $μ \approx μ_h[\pa↦μ(\pa)]$, we unfold $\mathit{hide}_\pa$, fix
  $\pa' ∈ \dom(μ)$ and show
  \[
    \dom(μ) ⊦ μ(\pa')(μ) \sim μ(\pa')(μ_h[\pa↦μ(\pa)])
  \]
  Which can be shown by extensionality of $μ(\pa')$ applied to the induction
  hypothesis.
\end{proof}

\begin{lemma}
  \label{thm:adom-dead}
  Let $A ⊦ d$. Then any $\pa \not∈ A$ is dead in $d$.
\end{lemma}
\begin{proof}
  Assume $μ_1 \approx μ_2$ such that $\pa$ is dead in $\rng(μ_i)$ and $\dom(μ_1) ∪ \{\pa\} ⊦ d$
  and fix arbitrary $d_1,d_2$.
  We have to show that
  \[
    \dom(μ_1) ⊦ d(μ_1[\pa↦d_1]) \sim d(μ_2[\pa↦d_2])
  \]

  We assume that $A ⊆ \dom(μ_i)$.
  Otherwise, we can extend $μ_i$ to heaps $μ_i'$ (mapping to equal entries, for
  example $d$) such that $A ⊆ \dom(μ_i')$.
  Then $μ_i \forcesto μ_i'$ and we can apply \Cref{thm:lazy-force-bisimilar}.

  W.l.o.g., $A ⊆ \dom(μ_i)$.
  By \Cref{thm:heap-hiding}, there exist $μ_i'$ such that $μ_i[\pa↦d_i] \approx μ_i'[\pa↦d_i]$
  and $\pa \not∈ \dom(μ_i')$, so $μ_i' \forcesto μ_i'[\pa↦d_i]$.
  By extensionality of $d$, we know that
  \[
    \dom(μ_1') ⊦ d(μ_1') \sim d(μ_2')
  \]
  Since $A ⊆ \dom(μ_i')$ and $A ⊦ d$, we can apply \Cref{thm:lazy-force-bisimilar}, getting
  \[
    \dom(μ_1') ⊦ d(μ_1'[\pa↦d_i]) \sim d(μ_2'[\pa↦d_i])
  \]
  And again by extensionality applied to $μ_i[\pa↦d_i] \approx μ_i'[\pa↦d_i]$
  and transitivity, we show the goal.
\end{proof}

\begin{lemma}[Heap forcing and bisimilarity]
  \label{thm:force-heap-bisimlar}
  Let $d_1,d_2 ∈ \EventD$, $A ⊆ \adom(d)$ and $μ_1,μ_2,μ_1',μ_2' ∈ \Heaps$
  such that $\adom(d_i) ⊆ \dom(μ_i)$.
  If $A ⊦ d_1(μ_1) \sim d_2(μ_2)$ and $μ_1 \forcesto μ_1'$, $μ_2 \forcesto μ_2'$,
  then $A ⊦ d_1(μ_1') \sim d_2(μ_2')$.
\end{lemma}
\begin{proof}
  By applying \Cref{thm:lazy-force-bisimilar} twice and transitivity of $\wild ⊦ \wild \sim \wild$.
\end{proof}

\begin{lemma}[Deadness approximates address domain]
  \label{thm:addr-dead}
  Let $\pe$ be an expression, $\px$ a variable and $\pa$ an address.
  If $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\deref(\pa)]})$ for any $ρ$ such that
  $\pa$ is dead in $\rng(ρ)$, then $\px$ is dead in $\pe$.
\end{lemma}
\begin{proof}
  To show that $\px$ is dead in $\pe$, we have to show
  \[
    \semevt{\Let{\px}{\pe_1}{\pe}}_ρ \equiv \semevt{\Let{\px}{\pe_1}{\pe}}_ρ
  \]
  for any $\pe_1,\pe_2$ and $ρ$.

  So assume that $μ_1 \approx μ_2$ for arbitrary $μ_1,μ_2$ (satisfying
  well-addressedness constraints).
  We have to show that
  \[
    \dom(μ_1) ⊦ \semevt{\Let{\px}{\pe_1}{\pe}}_{ρ}(μ_1) \sim \semevt{\Let{\px}{\pe_2}{\pe}}_{ρ}(μ_2)
  \]
  We unfold the $\mathbf{let}$ case of $\semevt{\wild}$ and show
  \[
    \dom(μ_1) ⊦ \semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ_1[\pa↦d_1]) \sim \semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ_2[\pa↦d_2])
  \]
  For arbitrary $d_1,d_2$ (which we may set to
  $d_i \triangleq \semevt{\pe_i}_{ρ[\px↦\deref(\pa)]}$).
  But $\pa$ is dead in $\rng(ρ)$ due to \Cref{thm:well-addressedness},
  so $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\deref(\pa)]}$ per assumption.
  Hence we can show the goal, applying to $μ_1 \approx μ_2$.
\end{proof}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live-3}]
  \label{prf:semusg-correct-live-3}
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$.
  We do so by applying \Cref{thm:addr-dead},
  so we instead assume that an address $\pa$ is dead in the range of an
  environment $ρ$ and show that $\pa$ is dead in
  $\semevt{\pe}_{ρ[\px↦\deref(\pa)]}$.

  We assume that $μ_1 \approx μ_2$ such that $\pa$ is dead in $\rng(μ_i)$, $\dom(μ_1) ∪ \{\pa\} ⊦ \semevt{\pe}_{ρ[\px↦\deref(\pa)]}$ and
  abbreviate $A \triangleq \dom(μ_1)$. Then the goal is to show
  \[
    A ⊦ \semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ_1[\pa↦d_1]) \sim \semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ_2[\pa↦d_2])
  \]
  for any $d_1,d_2$ and $ρ$ such that $\pa$ is dead in $\rng(ρ)$.
  We proceed by induction on $\pe$.
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then
      $\semusg{\py}_{\tr} = \semusg{\px}_{\tr}$, contradicting the inequality.
      If $\px \not= \py$, then $\pa$ is dead in $\semevt{\py}_{ρ[\px↦\deref(\pa)]}=ρ(\py)$.

    \item \textbf{Case $\pe = \Lam{\py}{\pe'}$}:
      We abbreviate
      $μ_i' \triangleq μ_i[\pa↦d_i]$, $ρ' \triangleq ρ[\px↦\deref(\pa)]$
      and have to show
      \[
        A ⊦ \goodend{\FunV(\fn{d}{\semevt{\pe'}_{ρ'[\py↦d]}}), μ_1'} \sim \goodend{\FunV(\fn{d}{\semevt{\pe'}_{ρ'[\py↦d]}}), μ_2'},
      \]
      which requires us to show
      \[
        \forall d.\ \later (A ⊦ d) ⟹  A ⊦ \semevt{\pe'}_{ρ'[\py↦d]}(μ_1') \sim \semevt{\pe'}_{ρ'[\py↦d]}(μ_2')
      \]
      Crucially, the address restriction on $d$ means that $\pa$ is dead in $d$
      per \Cref{thm:adom-dead}, so the proof is a simple matter of applying the
      inductive hypothesis.

    \item \textbf{Case $\pe = \pe'~\py$}:
      $\pa$ is trivially dead in the stuck case, so we assume that there exists
      $d_\py \triangleq ρ(\py)$ and $\pa$ is dead in $d_\py$ per assumption.
      We unfold $\apply$ and abbreviate
      $d_{\pe'} \triangleq \semevt{\pe'}_{ρ[\px↦\deref(\pa)]}$,
      $k \triangleq \fn{(\FunV(f))}{f(d_\py)}$, so the goal is to prove
      \[
        A ⊦ (d_{\pe'} \betastep k)(μ_1[\pa↦d_1]) \sim (d_{\pe'} \betastep k)(μ_2[\pa↦d_2])
      \]
      Since $d_{\pe'} \equiv d_{\pe'}$, the only interesting case is when
      $\bigstep{d_{\pe'}}{μ_i[\pa↦d_i]}{\FunV(f_i)}{μ_i'}$, in which case we
      have to show that
      \[
        A ⊦ f_1(d_\py)(μ_1') \sim f_2(d_\py)(μ_2').
      \]
      But $A ⊦ d_\py$ by \Cref{thm:well-addressedness}, so we can apply the
      premise of the $\eqfun$ judgment at the end of the $d_{\pe'}$ trace.

    \item \textbf{Case $\pe = \Let{\py}{\pe_1}{\pe_2}$}:
      We abbreviate
      ${ρ' \triangleq ρ[\px↦\deref(\pa)]}$,
      $d_{\pe_i} \triangleq \semevt{\pe_i}_{ρ'[\py↦\deref(\pa')]}$,
      ${μ_i' \triangleq μ_i[\pa↦d_i]}$,
      so the goal is to prove
      \[
        A ⊦ d_{\pe_2}(μ_1[\pa↦d_1][\pa'↦d_{\pe_1}]) \sim d_{\pe_2}(μ_2[\pa↦d_2][\pa'↦d_{\pe_1}])
      \]
      where $\pa' \not∈ \dom(μ_i)$ and $\pa' \not= \pa$.

      Since there can be no shadowing, it is $\px \not= \py$ and we see that
      $\tr(\px) = \tr'(\px)$, where
      $\tr' \triangleq {\operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦
      \semusg{\pe_1}_{\tr'}]})}$.
      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      but we cannot apply the induction hypothesis yet, because
      $\pa$ might not be dead in $d_{\pe_1}$ and thus not in
      $μ_i[\pa'↦d_{\pe_1}]$.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite $d_{\pe_1}$ to
          $d_{\pe_1}' \triangleq \semevt{\Lam{x}{x}}_{[]}$, and $\pa$ is dead in that.
          Then we apply the induction hypothesis to the heaps
          $μ_i[\pa'↦d_{\pe_1}']$ (noting that $μ_1[\pa'↦d_{\pe_1}'] \approx
          μ_2[\pa'↦d_{\pe_1}']$ and that $\pa$ is dead in the range of both) and
          then rewrite back to $d_{\pe_1}$:
          \[\begin{array}{rcl}
            A & ⊦    & \semevt{\pe_2}_{ρ'[\py↦\deref(\pa')]}(μ_1[\pa'↦d_{\pe_1}]) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\deref(\pa')]}(μ_1[\pa'↦d_{\pe_1}']) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\deref(\pa')]}(μ_2[\pa'↦d_{\pe_1}']) \\
              & \sim & \semevt{\pe_2}_{ρ'[\py↦\deref(\pa')]}(μ_2[\pa'↦d_{\pe_1}]) \\
          \end{array}\]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\pa$ is dead in $d_{\pe_1}$ and thus in the range of
          $μ_i[\pa'↦d_{\pe_i}']$ and we may invoke the induction hypothesis
          directly to show the goal.
      \end{itemize}
  \end{itemize}
\end{proof}

\subsection{Bare-bones Denotational Semantics for Call-by-need}

\begin{figure}
\[\begin{array}{c}
 \begin{array}{rrclclrrclcl}
 \end{array} \\
 \begin{array}{rrclclrrcrclcl}
  \text{Environment}  & ρ   & ∈ & \Environments  & =      & \Var \pfun \BareD
  &
  \text{Heap}         & μ   & ∈ & \Heaps         & =      & \Addresses \pfun \later\BareD
  \\
  \\[-0.5em]
  \text{Trace} & τ      & ∈          & \BTraces & ::= & \goodend{v,μ} \mid \stuckend{} \mid \laterC(τ^{\later})
  &
  \multicolumn{3}{r}{\text{Delayed trace}} & τ^{\later} & ∈ & \later\BTraces &   &
  \\
  \text{Domain} & d & ∈ & \BareD & = & \Heaps \to \BTraces
  &
  \multicolumn{3}{r}{\text{Delayed element}} & d^{\later} & ∈ & \later\BareD &   &
  \\
  \\[-0.5em]
 \end{array} \\
 \begin{array}{rrclcl}
  \text{Value} & v & ∈ & \BareV & ::= & \FunV(f ∈ (\later\BareD \to \BareD)) \mid \ConV(K,\many{d^{\later}}^{α_K}) \\
 \end{array} \\
  \\[-0.5em]
\end{array}\]
\[\begin{array}{c}
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{
    \begin{array}{c}
      (\betastep) : \BTraces \to (\BareV \times \Heaps \pfun \BTraces) \to \BTraces \quad  \ret : \BareV \to \BareD \\
      \deref : \Addresses \to \BareD \quad \apply : \BTraces \to \BareD \to \BTraces \\
    \end{array}
  }} \\
  \\[-0.5em]
  τ \betastep f & = & \begin{cases}
      \laterC^n(f(v,μ)) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) ∈ \dom(f)$} \\
      \laterC^n(\stuckend{}) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) \not∈ \dom(f)$} \\
      τ & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \ret(\lbl,v)(μ) & = & \goodend{v,μ} \\
  \deref(\pa)(μ) & = & μ(\pa)(μ) \betastep \fn{(v,μ)}{\goodend{(v,μ[\pa ↦ \ret(v)])}} \\
 \end{array} \\
 \\[-0.5em]
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{ \sembare{\wild} \colon \Exp → (\Var \pfun \BareD) → \BareD } } \\
  \\[-0.5em]
  \sembare{\px}_ρ & = & \begin{cases}
    ρ(\px) & \px ∈ \dom(ρ) \\
    \stuckend{} & \text{otherwise}
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Lam{\px}{\pe}}_ρ & = & \ret(\FunV(\fn{d^\later}{\sembare{\pe}_{ρ[\px↦d^\later]}})) \\
  \\[-0.5em]
  \sembare{\pe~\px}_ρ(μ) & = & \begin{cases}
      \sembare{\pe}_ρ(μ) \betastep \fn{(\FunV(f),μ)}{f(ρ(\px))(μ)} & \px ∈ \dom(ρ) \\
      \stuckend{} & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Let{\px}{\pe_1}{\pe_2}}_ρ(μ) & = & \begin{letarray}
    \text{let} & ρ' = ρ[\px ↦ \deref(\pa)] \quad \text{where $\pa \not∈ \dom(μ)$} \\
    \text{in}  & \sembare{\pe_2}_{ρ'}(μ[\pa ↦ \sembare{\pe_1}_{ρ'}]) \\
  \end{letarray} \\
  \\[-0.5em]
  \sembare{K~\many{\px}}_ρ & = & \ret(\ConV(K,\many{\sembare{\px}_ρ})) \\
  \\[-0.5em]
  \sembare{\Case{\pe_s}{\Sel[r]}}_ρ(μ) & = & \sembare{\pe_s}_ρ(μ) \betastep \fn{(\ConV(K',\many{d^\later}),μ)}{\sembare{\pe_r}_{ρ[\many{\px↦d^\later}]}(μ)} \\
                                     &   & \hspace{10em} \text{where } K_i = K' \\
 \end{array}
  \\[-0.5em]
\end{array}\]
\caption{Bare-bones Denotational Semantics $\sembare{-}$}
  \label{fig:sembare}
\end{figure}

