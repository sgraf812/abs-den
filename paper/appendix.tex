%include custom.fmt

\renewcommand\thefigure{\thesection.\arabic{figure}}

\subsection{Proofs}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live}]
  \label{prf:semusg-correct-live}
  By induction on $\pe$.
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$,
  so we are given an arbitrary $ρ$, $d_1$ and $d_2$ and have to show that
  $\semscott{\pe}_{ρ[\px↦d_1]} = \semscott{\pe}_{ρ[\px↦d_2]}$.
  By cases on $\pe$:
  \begin{itemize}
    \item \textbf{Case $\pe\triangleq\py$}: If $\px=\py$, then
      $\tr(\px) \not⊑ \semusg{\py}_{\tr} = \tr(\py) = \tr(\px)$, a contradiction.
      If $\px \not= \py$, then varying the entry for $\px$ won't matter; hence
      $\px$ is dead in $\py$.
    \item \textbf{Case $\pe\triangleq\Lam{\py}{\pe'}$}: The equality follows from
      pointwise equality on functions, so we pick an arbitrary $d$ to show
      $\semscott{\pe'}_{ρ[\px↦d_1][\py↦d]} = \semscott{\pe'}_{ρ[\px↦d_2][\py↦d]}$.

      This is simple to see if $\px=\py$. Otherwise, $\tr[\py↦\bot]$ witnesses the fact that
      \[
        \tr[\py↦\bot](\px) = \tr(\px) \not⊑
        \semusg{\Lam{\px}{\pe'}}_{\tr} = \semusg{\pe'}_{\tr[\py↦\bot]}
      \]
      so we can apply the induction hypothesis to see that $\px$ must be dead in
      $\pe'$, hence the equality on $\semscott{\pe'}$ holds.
    \item \textbf{Case $\pe\triangleq\pe'~\py$}:
      From $\tr(\px) \not⊑ \semusg{\pe'}_{\tr} + ω*\tr(\py)$ we can see that
      $\tr(\px) \not⊑ \semusg{\pe'}_{\tr}$ and $\tr(\px) \not⊑ \tr(\py)$ by
      monotonicity of $+$ and $*$.
      If $\px=\py$ then the latter inequality leads to a contradiction.
      Otherwise, $\px$ must be dead in $\pe'$, hence both cases of
      $\semscott{\pe'~\py}$ evaluate equally, differing only in
      the environment. It remains to be shown that
      $ρ[\px↦d_1](\py) = ρ[\px↦d_2](\py)$, and that is easy to see since
      $\px \not= \py$.
    \item \textbf{Case $\pe\triangleq\Let{\py}{\pe_1}{\pe_2}$}:
      We have to show that
      \[
        \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
      \]
      where $d'_i$ satisfy $d'_i = \semscott{\pe_1}_{ρ[\px↦d_i][\py↦d'_i]}$.
      The case $\px = \py$ is simple to see, because $ρ[\px↦d_i](\px)$ is never
      looked at.
      So we assume $\px \not= \py$ and see that $\tr(\px) = \tr'(\px)$, where
      $\tr' = \operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦ \semusg{\pe_1}_{\tr'}]})$.

      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      So by the induction hypothesis, $\px$ is dead in $\pe_2$.

%      Now consider the predicate $P(\tr) = \tr(\px) ⊑ \semusg{\pe_1}_{\tr}$.
%      We must prove it admissable to see that it holds (by fixpoint induction)
%      for $\tr'$. That is clearly the case because it is a composition of
%      continuous functions ($\tr, \semusg{\pe_1}$) and admissable predicates
%      ($⊑$).
%
%      SG: I think we don't need to prove that P above is admissable because
%      we never try to prove it through fixpoint induction; we simply apply LEM.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite
          \[
            \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_2]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
          \]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\px$ is dead in $\pe_1$ and $d'_1 = d'_2$. The goal follows
          from the fact that $\px$ is dead in $\pe_2$.
      \end{itemize}
  \end{itemize}
\end{proof}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live-3}]
  \label{prf:semusg-correct-live-3}
  By induction on $\pe$.
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$,
  so we are given an arbitrary $ρ, d_1, d_2, μ, \pa$ and have to show that
  $\semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ[\pa↦d_1]) = \semevt{\pe}_{ρ[\px↦\deref(\pa)]}(μ[\pa↦d_2])$.
  By cases on $\pe$:
  \begin{itemize}
    \item \textbf{Case $\pe\triangleq\py$}: If $\px=\py$, then
      $\semusg{\py}_{\tr} = \semusg{\px}_{\tr}$, a contradiction.
      If $\px \not= \py$, then varying the heap entry for $\pa$ won't matter,
      because $ρ(\py) \not= \deref(\pa)$ due to the freshness constraint; hence
      $\px$ is dead in $\py$.
    \item \textbf{Case $\pe\triangleq\Lam{\py}{\pe'}$}: The equality follows from
      pointwise equality on functions, so we pick arbitrary $μ, d^\later$ to show
      % Urgh, the μ that we start with is not the same as that reaches the subexpression.
      % It might already have evaluated d_1, d_2 which might cause them to eqaute.
      $\semevt{\pe'}_{ρ[\px↦\deref(\pa)][\py↦d^\later](μ[\pa↦])} = \semevt{\pe'}_{ρ[\px↦\deref(\pa)][\py↦d^\later]}$.

      This is simple to see if $\px=\py$. Otherwise, $\tr[\py↦\bot]$ witnesses the fact that
      \[
        \tr[\py↦\bot](\px) = \tr(\px) \not⊑
        \semusg{\Lam{\px}{\pe'}}_{\tr} = \semusg{\pe'}_{\tr[\py↦\bot]}
      \]
      so we can apply the induction hypothesis to see that $\px$ must be dead in
      $\pe'$, hence the equality on $\semevt{\pe'}$ holds.
    \item \textbf{Case $\pe\triangleq\pe'~\py$}:
      From $\tr(\px) \not⊑ \semusg{\pe'}_{\tr} + ω*\tr(\py)$ we can see that
      $\tr(\px) \not⊑ \semusg{\pe'}_{\tr}$ and $\tr(\px) \not⊑ \tr(\py)$ by
      monotonicity of $+$ and $*$.
      If $\px=\py$ then the latter inequality leads to a contradiction.
      Otherwise, $\px$ must be dead in $\pe'$, hence both cases of
      $\semevt{\pe'~\py}$ evaluate equally, differing only in
      the environment. It remains to be shown that
      $ρ[\px↦d_1](\py) = ρ[\px↦d_2](\py)$, and that is easy to see since
      $\px \not= \py$.
    \item \textbf{Case $\pe\triangleq\Let{\py}{\pe_1}{\pe_2}$}:
      We have to show that
      \[
        \semevt{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semevt{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
      \]
      where $d'_i$ satisfy $d'_i = \semevt{\pe_1}_{ρ[\px↦d_i][\py↦d'_i]}$.
      The case $\px = \py$ is simple to see, because $ρ[\px↦d_i](\px)$ is never
      looked at.
      So we assume $\px \not= \py$ and see that $\tr(\px) = \tr'(\px)$, where
      $\tr' = \operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦ \semusg{\pe_1}_{\tr'}]})$.

      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      So by the induction hypothesis, $\px$ is dead in $\pe_2$.

%      Now consider the predicate $P(\tr) = \tr(\px) ⊑ \semusg{\pe_1}_{\tr}$.
%      We must prove it admissable to see that it holds (by fixpoint induction)
%      for $\tr'$. That is clearly the case because it is a composition of
%      continuous functions ($\tr, \semusg{\pe_1}$) and admissable predicates
%      ($⊑$).
%
%      SG: I think we don't need to prove that P above is admissable because
%      we never try to prove it through fixpoint induction; we simply apply LEM.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite
          \[
            \semevt{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semevt{\pe_2}_{ρ[\px↦d_1][\py↦d'_2]} = \semevt{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
          \]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\px$ is dead in $\pe_1$ and $d'_1 = d'_2$. The goal follows
          from the fact that $\px$ is dead in $\pe_2$.
      \end{itemize}
  \end{itemize}
\end{proof}

\subsection{Bare-bones Denotational Semantics for Call-by-need}

\begin{figure}
\[\begin{array}{c}
 \begin{array}{rrclclrrclcl}
 \end{array} \\
 \begin{array}{rrclclrrcrclcl}
  \text{Environment}  & ρ   & ∈ & \Environments  & =      & \Var \pfun \BareD
  &
  \text{Heap}         & μ   & ∈ & \Heaps         & =      & \Addresses \pfun \later\BareD
  \\
  \\[-0.5em]
  \text{Trace} & τ      & ∈          & \BTraces & ::= & \goodend{v,μ} \mid \stuckend{} \mid \laterC(τ^{\later})
  &
  \multicolumn{3}{r}{\text{Delayed trace}} & τ^{\later} & ∈ & \later\BTraces &   &
  \\
  \text{Domain} & d & ∈ & \BareD & = & \Heaps \to \BTraces
  &
  \multicolumn{3}{r}{\text{Delayed element}} & d^{\later} & ∈ & \later\BareD &   &
  \\
  \\[-0.5em]
 \end{array} \\
 \begin{array}{rrclcl}
  \text{Value} & v & ∈ & \BareV & ::= & \FunV(f ∈ (\later\BareD \to \BareD)) \mid \ConV(K,\many{d^{\later}}^{α_K}) \\
 \end{array} \\
  \\[-0.5em]
\end{array}\]
\[\begin{array}{c}
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{
    \begin{array}{c}
      (\betastep) : \BTraces \to (\BareV \times \Heaps \pfun \BTraces) \to \BTraces \quad  \ret : \BareV \to \BareD \\
      \deref : \Addresses \to \BareD \quad \apply : \BTraces \to \BareD \to \BTraces \\
    \end{array}
  }} \\
  \\[-0.5em]
  τ \betastep f & = & \begin{cases}
      \laterC^n(f(v,μ)) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) ∈ \dom(f)$} \\
      \laterC^n(\stuckend{}) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) \not∈ \dom(f)$} \\
      τ & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \ret(\lbl,v)(μ) & = & \goodend{v,μ} \\
  \deref(\pa)(μ) & = & μ(\pa)(μ) \betastep \fn{(v,μ)}{\goodend{(v,μ[\pa ↦ \ret(v)])}} \\
 \end{array} \\
 \\[-0.5em]
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{ \sembare{\wild} \colon \Exp → (\Var \pfun \BareD) → \BareD } } \\
  \\[-0.5em]
  \sembare{\px}_ρ & = & \begin{cases}
    ρ(\px) & \px ∈ \dom(ρ) \\
    \stuckend{} & \text{otherwise}
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Lam{\px}{\pe}}_ρ & = & \ret(\FunV(\fn{d^\later}{\sembare{\pe}_{ρ[\px↦d^\later]}})) \\
  \\[-0.5em]
  \sembare{\pe~\px}_ρ(μ) & = & \begin{cases}
      \sembare{\pe}_ρ(μ) \betastep \fn{(\FunV(f),μ)}{f(ρ(\px))(μ)} & \px ∈ \dom(ρ) \\
      \stuckend{} & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Let{\px}{\pe_1}{\pe_2}}_ρ(μ) & = & \begin{letarray}
    \text{let} & ρ' = ρ[\px ↦ \deref(\pa)] \quad \text{where $\pa \not∈ \dom(μ)$} \\
    \text{in}  & \sembare{\pe_2}_{ρ'}(μ[\pa ↦ \sembare{\pe_1}_{ρ'}]) \\
  \end{letarray} \\
  \\[-0.5em]
  \sembare{K~\many{\px}}_ρ & = & \ret(\ConV(K,\many{\sembare{\px}_ρ})) \\
  \\[-0.5em]
  \sembare{\Case{\pe_s}{\Sel[r]}}_ρ(μ) & = & \sembare{\pe_s}_ρ(μ) \betastep \fn{(\ConV(K',\many{d^\later}),μ)}{\sembare{\pe_r}_{ρ[\many{\px↦d^\later}]}(μ)} \\
                                     &   & \hspace{10em} \text{where } K_i = K' \\
 \end{array}
  \\[-0.5em]
\end{array}\]
\caption{Bare-bones Denotational Semantics $\sembare{-}$}
  \label{fig:sembare}
\end{figure}

