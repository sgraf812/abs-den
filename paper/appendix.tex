%include custom.fmt

\renewcommand\thefigure{\thesection.\arabic{figure}}

\subsection{Proofs}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live}]
  \label{prf:semusg-correct-live}
  By induction on $\pe$.
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$,
  so we are given an arbitrary $ρ$, $d_1$ and $d_2$ and have to show that
  $\semscott{\pe}_{ρ[\px↦d_1]} = \semscott{\pe}_{ρ[\px↦d_2]}$.
  By cases on $\pe$:
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then
      $\tr(\px) \not⊑ \semusg{\py}_{\tr} = \tr(\py) = \tr(\px)$, a contradiction.
      If $\px \not= \py$, then varying the entry for $\px$ won't matter; hence
      $\px$ is dead in $\py$.
    \item \textbf{Case $\pe = \Lam{\py}{\pe'}$}: The equality follows from
      pointwise equality on functions, so we pick an arbitrary $d$ to show
      $\semscott{\pe'}_{ρ[\px↦d_1][\py↦d]} = \semscott{\pe'}_{ρ[\px↦d_2][\py↦d]}$.

      This is simple to see if $\px=\py$. Otherwise, $\tr[\py↦\bot]$ witnesses the fact that
      \[
        \tr[\py↦\bot](\px) = \tr(\px) \not⊑
        \semusg{\Lam{\py}{\pe'}}_{\tr} = \semusg{\pe'}_{\tr[\py↦\bot]}
      \]
      so we can apply the induction hypothesis to see that $\px$ must be dead in
      $\pe'$, hence the equality on $\semscott{\pe'}$ holds.
    \item \textbf{Case $\pe = \pe'~\py$}:
      From $\tr(\px) \not⊑ \semusg{\pe'}_{\tr} + ω*\tr(\py)$ we can see that
      $\tr(\px) \not⊑ \semusg{\pe'}_{\tr}$ and $\tr(\px) \not⊑ \tr(\py)$ by
      monotonicity of $+$ and $*$.
      If $\px=\py$ then the latter inequality leads to a contradiction.
      Otherwise, $\px$ must be dead in $\pe'$, hence both cases of
      $\semscott{\pe'~\py}$ evaluate equally, differing only in
      the environment. It remains to be shown that
      $ρ[\px↦d_1](\py) = ρ[\px↦d_2](\py)$, and that is easy to see since
      $\px \not= \py$.
    \item \textbf{Case $\pe = \Let{\py}{\pe_1}{\pe_2}$}:
      We have to show that
      \[
        \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
      \]
      where $d'_i$ satisfy $d'_i = \semscott{\pe_1}_{ρ[\px↦d_i][\py↦d'_i]}$.
      The case $\px = \py$ is simple to see, because $ρ[\px↦d_i](\px)$ is never
      looked at.
      So we assume $\px \not= \py$ and see that $\tr(\px) = \tr'(\px)$, where
      $\tr' = \operatorname{fix}(\fn{\tr'}{\tr ⊔ [\py ↦ \semusg{\pe_1}_{\tr'}]})$.

      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      So by the induction hypothesis, $\px$ is dead in $\pe_2$.

%      Now consider the predicate $P(\tr) = \tr(\px) ⊑ \semusg{\pe_1}_{\tr}$.
%      We must prove it admissable to see that it holds (by fixpoint induction)
%      for $\tr'$. That is clearly the case because it is a composition of
%      continuous functions ($\tr, \semusg{\pe_1}$) and admissable predicates
%      ($⊑$).
%
%      SG: I think we don't need to prove that P above is admissable because
%      we never try to prove it through fixpoint induction; we simply apply LEM.

      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality.
          Both deadness facts together allow us to rewrite
          \[
            \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_1]} = \semscott{\pe_2}_{ρ[\px↦d_1][\py↦d'_2]} = \semscott{\pe_2}_{ρ[\px↦d_2][\py↦d'_2]}
          \]
          as requested.
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\px$ is dead in $\pe_1$ and $d'_1 = d'_2$. The goal follows
          from the fact that $\px$ is dead in $\pe_2$.
      \end{itemize}
  \end{itemize}
\end{proof}

\begin{lemma}[Deadness of $(\betastep)$]
  \label{thm:deadness-beta}
  Let $\pa$ be dead in $d ∈ \EventD$, and let $f : \EventV \pfun \EventD$ map
  values that $\pa$ is dead in to elements that $\pa$ is dead in (quite like
  the deadness requirement on $\FunV(f)$).
  Then $\pa$ is dead in $d \betastep f$.
\end{lemma}
\begin{proof}
  We use deadness of $d$ to see that $μ'_1 \sim^{\Heaps}_\pa μ'_2$, which in turn
  means that $f(v)(μ_1) \sim^{\Traces}_\pa f(v)(μ_1)$.
  The rest is just packing and unpacking the equivalence relation.
\end{proof}

\begin{lemma}[Deadness of $\deref$]
  \label{thm:deadness-deref}
  Let $\pa, \pa'$ be two distinct addresses.
  Then $\pa$ is dead in $\deref(\pa')$.
\end{lemma}
\begin{proof}
  Assuming $μ_1 \sim^{\Heaps}_\pa μ_2$, it follows that $\pa$ is dead in
  $μ_i(\pa')$ by the deadness requirement.
  Likewise, given a value $v$ that $\pa$ is dead in, it is a simple
  matter of unpacking and repacking equality proofs see that the body
  of the function argument
  $\UpdateA(\pa↦\ret(v)) \cons \goodend{v,μ'_i[\pa↦\ret(v)]}$
  evaluates bisimilarly \wrt $\sim^{\Traces}_\pa$ given that
  $μ'_1 \sim^{\Heaps}_\pa μ'_2$.
  \Cref{thm:deadness-beta} concludes the proof.
\end{proof}

\begin{lemma}[Deadness of $\apply$]
  \label{thm:deadness-apply}
  Let $\pa$ be dead in $d_\pe$ and $d_\px$.
  Then $\pa$ is dead in $\apply(d_\pe, d_\px)$.
\end{lemma}
\begin{proof}
  By simple unpacking and repacking congruences until \Cref{thm:deadness-beta}
  is applicable, similar to \Cref{thm:deadness-deref}.
\end{proof}

\begin{lemma}[Deadness without $\deref$]
  \label{thm:deadness-no-deref}
  Let $\pe$ be an expression, $\pa$ an address and $ρ$ a usage environment, where
  $\pa$ is dead in $\rng(ρ)$.
  Then $\pa$ is dead in $\semevt{\pe}_ρ$.
\end{lemma}
\begin{proof}
  Assume $μ_1 \sim^{\Heaps}_\pa μ_2$, then the goal is to show
  $\semevt{\pe}_ρ(μ_1) \sim^{\Heaps}_\pa \semevt{\pe}_ρ(μ_1)$.

  By induction on $\pe$. The only interesting case is
  $\pe = \Let{\px}{\pe_1}{\pe_2}$, where we extend the heap with new
  $\deref(\pa')$ actions that $\pa$ might potentially be live in.
  But since $\pa'$ is drawn freshly, and $\pa ∈ \dom(μ_1) ∩ \dom(μ_2)$
  due to the assumption, we have $\pa' \not= \pa$ and can apply
  \Cref{thm:deadness-deref} to conclude the proof.
\end{proof}

\begin{proof}[Proof of \Cref{thm:semusg-correct-live-3}]
  \label{prf:semusg-correct-live-3}
  By induction on $\pe$.
  We fix $\pe$, $\px$ and $\tr$ such that $\tr(\px) \not⊑ \semusg{\pe}_{\tr}$.
  The goal is to show that $\px$ is dead in $\pe$,
  so we are given an arbitrary $ρ, \pa$ with $\pa$ dead in $\rng(ρ)$ and have to show that
  $\pa$ is dead in $\semevt{\pe}_{ρ[\px↦\deref(\pa)]}$.
  By cases on $\pe$:
  \begin{itemize}
    \item \textbf{Case $\pe = \py$}: If $\px=\py$, then
      $\semusg{\py}_{\tr} = \semusg{\px}_{\tr}$, contradicting the inequality.
      If $\px \not= \py$, then $\pa$ is dead in
      $\semevt{\py}_{ρ[\px↦\deref(\pa)]}=ρ(\py)$ because $\pa$ is dead in $ρ(\py)$
      by assumption.
    \item \textbf{Case $\pe = \Lam{\py}{\pe'}$}:
      Let $v$ be any value such that $\dead^{\EventV}_{\pa}(v)$;
      then $\dead^{\EventD}_{\pa}(\ret(v))$ follows from
      unfolding $\ret$.

      So for the lambda case, it's enough to prove
      $\dead^{\EventV}_{\pa}(\FunV(f))$, where
      \[
        f \triangleq\fn{d^\later}{\AppEA(\py↦d^\later) \cons \semevt{\pe'}_{ρ[\px↦\deref(\pa)][\py↦d^\later]}}.
      \]
      Hence let us pick arbitrary $μ_i, d^\later$ such that
      $μ_1\sim^{\Heaps}_{\pa} μ_2$ and
      $\dead^{\EventD}_{\pa}(d^\later)$
      and show
      \[
        f(d^\later)(μ_1)\sim^{\Traces}_{\pa} f(d^\later)(μ_2).
      \]
      This follows by congruence once we show that $\pa$ is dead in
      $d \triangleq \semevt{\pe'}_{ρ[\px↦\deref(\pa)][\py↦d^\later]}$.

      If $\px=\py$ then $d = \semevt{\pe'}_{ρ[\py↦d^\later]}$
      where $\pa$ is dead in $\rng(ρ[\py↦d^\later])$, hence $\pa$ is also
      dead in $d$ by \Cref{thm:deadness-no-deref}.

      Otherwise, $\px \not= \py$ and $\tr[\py↦\bot]$ witnesses the fact that
      \[
        \tr[\py↦\bot](\px) = \tr(\px) \not⊑
        \semusg{\Lam{\py}{\pe'}}_{\tr} = \semusg{\pe'}_{\tr[\py↦\bot]},
      \]
      so we can apply the induction hypothesis to see that $\px$ must be dead in
      $\pe'$.
      On the other hand, we can use $\px \not= \py$ to commute the environment
      updates to
      $d = \semevt{\pe'}_{ρ[\py↦d^\later][\px↦\deref(\pa)]}$.
      Now, $\pa$ is dead in $d^\later$, as per assumption, and likewise for
      $\rng(ρ[\py↦d^\later])$.
      By \Cref{defn:deadness4}, we can apply that $\px$ is dead in $\pe'$ to
      this setup to conclude that $\pa$ is dead in $d$.
    \item \textbf{Case $\pe = \pe'~\py$}:
      $\pa$ is trivially dead in the stuck case, so we assume that there exists
      $d_\py \triangleq ρ(\py)$ that $\pa$ is dead in.

      From $\tr(\px) \not⊑ \semusg{\pe'}_{\tr} + ω*\tr(\py)$ we can see that
      $\tr(\px) \not⊑ \semusg{\pe'}_{\tr}$ and $\tr(\px) \not⊑ \tr(\py)$ by
      monotonicity of $+$ and $*$.
      The former inequality yields that $\px$ must be dead in $\pe'$ via the
      induction hypothesis, while the latter proves that $\px \not= \py$.

      Since $\px$ is dead in $\pe'$, we know that $\pa$ is dead in
      $\semevt{\pe'}_ρ$. Likewise, $\pa$ is dead in $d_\py$, so we can
      apply \Cref{thm:deadness-apply} to conclude the proof.
    \item \textbf{Case $\pe = \Let{\py}{\pe_1}{\pe_2}$}:
      The case $\px = \py$ is easily discharged by \Cref{thm:deadness-no-deref}.

      We assume $\px \not= \py$ and $μ_1 \sim^{\Heaps}_\pa μ_2$ and allocate
      $\pa' \not∈ \dom(μ_i)$.
      The chosen $\pa'$ must be distinct from $\pa$, because $\pa ∈ \dom(μ_i)$.
      As a consequence, we know that $\pa$ is dead in the range of
      $ρ' \triangleq ρ[\py ↦ \deref(\pa')]$ by \Cref{thm:deadness-deref}.

      The goal is to show (for $d_1^\later = \semevt{\pe_1}_{ρ'}$)
      \[
        \semevt{\pe_2}_{ρ'}(μ_1[\pa' ↦ d_1^\later]) \sim^{\Traces}_\pa \semevt{\pe_2}_{ρ'}(μ_2[\pa' ↦ d_1^\later])
      \]
      The challenge here is that $\pa$ might not be dead in $d_1^\later$,
      which prohibits us from invoking the induction hypothesis on $\pe_2$.

      For the analysis function, we see that $\tr(\px) = \tr'(\px)$, where
      $\tr' = \operatorname{fix}(\fn{\tr'}{\tr~⊔~[\py~↦~\semusg{\pe_1}_{\tr'}]})$.
      We know that
      \[
        \tr'(\px) = \tr(\px) \not⊑ \semusg{\pe}_{\tr} = \semusg{\pe_2}_{\tr'}
      \]
      So by the induction hypothesis, $\px$ is dead in $\pe_2$.
      We proceed by cases over $\tr(\px) = \tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$.
      \begin{itemize}
        \item \textbf{Case $\tr'(\px) \not⊑ \semusg{\pe_1}_{\tr'}$}:
          Then $\px$ is dead in $\pe_1$ and hence $\pa$ is dead in $d_1^\later$.
          Hence we have $μ_1[\pa' ↦ d_1^\later] \sim^{\Heaps}_\pa μ_2[\pa' ↦ d_1^\later]$
          The goal follows from the fact that $\px$ is dead in $\pe_2$.
        \item \textbf{Case $\tr'(\px) ⊑ \semusg{\pe_1}_{\tr'}$}: Then
          $\tr'(\px) ⊑ \tr'(\py)$ and $\py$ is also dead in $\pe_2$ by the above
          inequality and the induction hypothesis.

          We can use this latter fact to rewrite the heap entry for $d_1^\later$
          to something that is dead in $\pa$, such as $\fn{\wild}{\stuckend{}}$:
          \[
            \semevt{\pe_2}_{ρ'}(μ_1[\pa' ↦ d_1^\later]) \sim^{\Traces}_\pa \semevt{\pe_2}_{ρ'}(μ_2[\pa' ↦ d_1^\later]) \sim^{\Traces}_\pa \semevt{\pe_2}_{ρ'}(μ_2[\pa' ↦ d_2^\later])
          \]
          That entails that $\$d_1^\later$ is dead in
          Since $μ_1[\pa' ↦ d_1^\later] $
          This allows us to show (for arbitrary $d_i^\later$)
          By applying deadness results for $\px$/$\pa$ and then $\py$/$\pa'$.
      \end{itemize}
      Applying the induction hypothesis, we see that $\px$ is dead in
      $\semevt{\pe_i}$ and hence that $\pa$ is dead in $\semevt{\pe_i}_{ρ'}$
      (this needs the deadness result on $ρ'$).

      We can use this to conclude that
      $μ_1[\pa ↦ d_1^\later] \sim^{\Heaps}_\pa μ_2[\pa ↦ d_1^\later]$
      and hence that
      \[
        \semevt{\pe_2}_{ρ'}(μ_1[\pa ↦ d_1^\later]) \sim^{\Traces}_\pa \semevt{\pe_2}_{ρ'}(μ_2[\pa ↦ d_1^\later])
      \]
      The rest is just congruence.
  \end{itemize}
\end{proof}

\subsection{Bare-bones Denotational Semantics for Call-by-need}

\begin{figure}
\[\begin{array}{c}
 \begin{array}{rrclclrrclcl}
 \end{array} \\
 \begin{array}{rrclclrrcrclcl}
  \text{Environment}  & ρ   & ∈ & \Environments  & =      & \Var \pfun \BareD
  &
  \text{Heap}         & μ   & ∈ & \Heaps         & =      & \Addresses \pfun \later\BareD
  \\
  \\[-0.5em]
  \text{Trace} & τ      & ∈          & \BTraces & ::= & \goodend{v,μ} \mid \stuckend{} \mid \laterC(τ^{\later})
  &
  \multicolumn{3}{r}{\text{Delayed trace}} & τ^{\later} & ∈ & \later\BTraces &   &
  \\
  \text{Domain} & d & ∈ & \BareD & = & \Heaps \to \BTraces
  &
  \multicolumn{3}{r}{\text{Delayed element}} & d^{\later} & ∈ & \later\BareD &   &
  \\
  \\[-0.5em]
 \end{array} \\
 \begin{array}{rrclcl}
  \text{Value} & v & ∈ & \BareV & ::= & \FunV(f ∈ (\later\BareD \to \BareD)) \mid \ConV(K,\many{d^{\later}}^{α_K}) \\
 \end{array} \\
  \\[-0.5em]
\end{array}\]
\[\begin{array}{c}
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{
    \begin{array}{c}
      (\betastep) : \BTraces \to (\BareV \times \Heaps \pfun \BTraces) \to \BTraces \quad  \ret : \BareV \to \BareD \\
      \deref : \Addresses \to \BareD \quad \apply : \BTraces \to \BareD \to \BTraces \\
    \end{array}
  }} \\
  \\[-0.5em]
  τ \betastep f & = & \begin{cases}
      \laterC^n(f(v,μ)) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) ∈ \dom(f)$} \\
      \laterC^n(\stuckend{}) & \text{$τ = \laterC^n(\goodend{v,μ}$) and $(v,μ) \not∈ \dom(f)$} \\
      τ & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \ret(\lbl,v)(μ) & = & \goodend{v,μ} \\
  \deref(\pa)(μ) & = & μ(\pa)(μ) \betastep \fn{(v,μ)}{\goodend{(v,μ[\pa ↦ \ret(v)])}} \\
 \end{array} \\
 \\[-0.5em]
 \begin{array}{rcl}
  \multicolumn{3}{c}{ \ruleform{ \sembare{\wild} \colon \Exp → (\Var \pfun \BareD) → \BareD } } \\
  \\[-0.5em]
  \sembare{\px}_ρ & = & \begin{cases}
    ρ(\px) & \px ∈ \dom(ρ) \\
    \stuckend{} & \text{otherwise}
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Lam{\px}{\pe}}_ρ & = & \ret(\FunV(\fn{d^\later}{\sembare{\pe}_{ρ[\px↦d^\later]}})) \\
  \\[-0.5em]
  \sembare{\pe~\px}_ρ(μ) & = & \begin{cases}
      \sembare{\pe}_ρ(μ) \betastep \fn{(\FunV(f),μ)}{f(ρ(\px))(μ)} & \px ∈ \dom(ρ) \\
      \stuckend{} & \text{otherwise} \\
    \end{cases} \\
  \\[-0.5em]
  \sembare{\Let{\px}{\pe_1}{\pe_2}}_ρ(μ) & = & \begin{letarray}
    \text{let} & ρ' = ρ[\px ↦ \deref(\pa)] \quad \text{where $\pa \not∈ \dom(μ)$} \\
    \text{in}  & \sembare{\pe_2}_{ρ'}(μ[\pa ↦ \sembare{\pe_1}_{ρ'}]) \\
  \end{letarray} \\
  \\[-0.5em]
  \sembare{K~\many{\px}}_ρ & = & \ret(\ConV(K,\many{\sembare{\px}_ρ})) \\
  \\[-0.5em]
  \sembare{\Case{\pe_s}{\Sel[r]}}_ρ(μ) & = & \sembare{\pe_s}_ρ(μ) \betastep \fn{(\ConV(K',\many{d^\later}),μ)}{\sembare{\pe_r}_{ρ[\many{\px↦d^\later}]}(μ)} \\
                                     &   & \hspace{10em} \text{where } K_i = K' \\
 \end{array}
  \\[-0.5em]
\end{array}\]
\caption{Bare-bones Denotational Semantics $\sembare{-}$}
  \label{fig:sembare}
\end{figure}

