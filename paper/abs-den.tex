% -*- mode: LaTeX -*-

%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review,anonymous,natbib=false]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall,screen]{acmart}\settopmatter{}

% https://github.com/borisveytsman/acmart/issues/406#issuecomment-667180341
\PassOptionsToPackage{prologue,dvipsnames}{xcolor}

\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}

%% Journal information
%%
\setcopyright{rightsretained}
\acmPrice{}
\acmDOI{10.1145/1111111}
\acmYear{2024}
\copyrightyear{2024}
%\acmSubmissionID{popl24main-p11-p}
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{POPL}
\acmArticle{1}
\acmMonth{1}

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations

% Some conditional build stuff for handling the Appendix

\newif\ifmain
\newif\ifappendix

% Builds only the main paper by default.
\maintrue
\appendixfalse
% But we provide a switch to build the Appendix only.
\def\appendixonly{\mainfalse{}\appendixtrue{}}

% .. so that you can comment out the following line to build the Appendix only
% This is done by the `make appendix.pdf` target.
%\appendixonly

% Same thing for an extended version that includes the Appendix
\def\extended{\maintrue{}\appendixtrue{}}
%\extended

%%%%%%%

\ifappendix
\usepackage[appendix=inline]{apxproof}
\else
\usepackage[appendix=strip]{apxproof}
\fi
\usepackage{array} % \newcolumntype
\usepackage{ifdraft}
\usepackage{cleveref}
\usepackage{xspace}
\usepackage{url}
\usepackage{varwidth}
\usepackage{galois}
\usepackage{hsyl-listing} % listing style, hsyl-style
%\usepackage{scalerel}
%\usepackage[all]{xy}
\usepackage{relsize} % relscale
\usepackage{xfp} % fpeval
%\usepackage{stackengine}
\usepackage{mathtools} % xhookrightarrow
\usepackage{trimclip} % clipbox
\usepackage{mathpartir} % inference rules
\usepackage{subcaption}
\usepackage{mathbbol} % \bbcolon and \bbquestionmark
\usepackage{stmaryrd} % \lightning
\usepackage{tikz}
\usepackage{witharrows}
\usetikzlibrary{cd} % commutative diagrams
\usetikzlibrary{calc}
\usetikzlibrary{fit}
\usetikzlibrary{patterns}
\usetikzlibrary{matrix}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{placeins} % flush floats with \FloatBarrier
\usepackage[T1]{fontenc} % https://tex.stackexchange.com/a/181119

\usepackage{utf8-symbols}
\input{macros}

\ifnonanon{\usepackage[mark]{gitinfo2}}

\let\Bbbk\relax
%% ODER: format ==         = "\mathrel{==}"
%% ODER: format /=         = "\neq "
%
%
\makeatletter
\@ifundefined{lhs2tex.lhs2tex.sty.read}%
  {\@namedef{lhs2tex.lhs2tex.sty.read}{}%
   \newcommand\SkipToFmtEnd{}%
   \newcommand\EndFmtInput{}%
   \long\def\SkipToFmtEnd#1\EndFmtInput{}%
  }\SkipToFmtEnd

\newcommand\ReadOnlyOnce[1]{\@ifundefined{#1}{\@namedef{#1}{}}\SkipToFmtEnd}
\usepackage{amstext}
\usepackage{amssymb}
\usepackage{stmaryrd}
\DeclareFontFamily{OT1}{cmtex}{}
\DeclareFontShape{OT1}{cmtex}{m}{n}
  {<5><6><7><8>cmtex8
   <9>cmtex9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmtex10}{}
\DeclareFontShape{OT1}{cmtex}{m}{it}
  {<-> ssub * cmtt/m/it}{}
\newcommand{\texfamily}{\fontfamily{cmtex}\selectfont}
\DeclareFontShape{OT1}{cmtt}{bx}{n}
  {<5><6><7><8>cmtt8
   <9>cmbtt9
   <10><10.95><12><14.4><17.28><20.74><24.88>cmbtt10}{}
\DeclareFontShape{OT1}{cmtex}{bx}{n}
  {<-> ssub * cmtt/bx/n}{}
\newcommand{\tex}[1]{\text{\texfamily#1}}	% NEU

\newcommand{\Sp}{\hskip.33334em\relax}


\newcommand{\Conid}[1]{\mathit{#1}}
\newcommand{\Varid}[1]{\mathit{#1}}
\newcommand{\anonymous}{\kern0.06em \vbox{\hrule\@width.5em}}
\newcommand{\plus}{\mathbin{+\!\!\!+}}
\newcommand{\bind}{\mathbin{>\!\!\!>\mkern-6.7mu=}}
\newcommand{\rbind}{\mathbin{=\mkern-6.7mu<\!\!\!<}}% suggested by Neil Mitchell
\newcommand{\sequ}{\mathbin{>\!\!\!>}}
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}
\usepackage{polytable}

%mathindent has to be defined
\@ifundefined{mathindent}%
  {\newdimen\mathindent\mathindent\leftmargini}%
  {}%

\def\resethooks{%
  \global\let\SaveRestoreHook\empty
  \global\let\ColumnHook\empty}
\newcommand*{\savecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\savecolumns[#1]}}
\newcommand*{\restorecolumns}[1][default]%
  {\g@addto@macro\SaveRestoreHook{\restorecolumns[#1]}}
\newcommand*{\aligncolumn}[2]%
  {\g@addto@macro\ColumnHook{\column{#1}{#2}}}

\resethooks

\newcommand{\onelinecommentchars}{\quad-{}- }
\newcommand{\commentbeginchars}{\enskip\{-}
\newcommand{\commentendchars}{-\}\enskip}

\newcommand{\visiblecomments}{%
  \let\onelinecomment=\onelinecommentchars
  \let\commentbegin=\commentbeginchars
  \let\commentend=\commentendchars}

\newcommand{\invisiblecomments}{%
  \let\onelinecomment=\empty
  \let\commentbegin=\empty
  \let\commentend=\empty}

\visiblecomments

\newlength{\blanklineskip}
\setlength{\blanklineskip}{0.66084ex}

\newcommand{\hsindent}[1]{\quad}% default is fixed indentation
\let\hspre\empty
\let\hspost\empty
\newcommand{\NB}{\textbf{NB}}
\newcommand{\Todo}[1]{$\langle$\textbf{To do:}~#1$\rangle$}

\EndFmtInput
\makeatother
%
%
%
%
%
%
% This package provides two environments suitable to take the place
% of hscode, called "plainhscode" and "arrayhscode". 
%
% The plain environment surrounds each code block by vertical space,
% and it uses \abovedisplayskip and \belowdisplayskip to get spacing
% similar to formulas. Note that if these dimensions are changed,
% the spacing around displayed math formulas changes as well.
% All code is indented using \leftskip.
%
% Changed 19.08.2004 to reflect changes in colorcode. Should work with
% CodeGroup.sty.
%
\ReadOnlyOnce{polycode.fmt}%
\makeatletter

\newcommand{\hsnewpar}[1]%
  {{\parskip=0pt\parindent=0pt\par\vskip #1\noindent}}

% can be used, for instance, to redefine the code size, by setting the
% command to \small or something alike
\newcommand{\hscodestyle}{}

% The command \sethscode can be used to switch the code formatting
% behaviour by mapping the hscode environment in the subst directive
% to a new LaTeX environment.

\newcommand{\sethscode}[1]%
  {\expandafter\let\expandafter\hscode\csname #1\endcsname
   \expandafter\let\expandafter\endhscode\csname end#1\endcsname}

% "compatibility" mode restores the non-polycode.fmt layout.

\newenvironment{compathscode}%
  {\par\noindent
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed\)%
   \par\noindent
   \ignorespacesafterend}

\newcommand{\compaths}{\sethscode{compathscode}}

% "plain" mode is the proposed default.
% It should now work with \centering.
% This required some changes. The old version
% is still available for reference as oldplainhscode.

\newenvironment{plainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\hspre\(\let\hspost\)%
   \pboxed}%
  {\endpboxed%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newenvironment{oldplainhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

% Here, we make plainhscode the default environment.

\newcommand{\plainhs}{\sethscode{plainhscode}}
\newcommand{\oldplainhs}{\sethscode{oldplainhscode}}
\plainhs

% The arrayhscode is like plain, but makes use of polytable's
% parray environment which disallows page breaks in code blocks.

\newenvironment{arrayhscode}%
  {\hsnewpar\abovedisplayskip
   \advance\leftskip\mathindent
   \hscodestyle
   \let\\=\@normalcr
   \(\parray}%
  {\endparray\)%
   \hsnewpar\belowdisplayskip
   \ignorespacesafterend}

\newcommand{\arrayhs}{\sethscode{arrayhscode}}

% The mathhscode environment also makes use of polytable's parray 
% environment. It is supposed to be used only inside math mode 
% (I used it to typeset the type rules in my thesis).

\newenvironment{mathhscode}%
  {\parray}{\endparray}

\newcommand{\mathhs}{\sethscode{mathhscode}}

% texths is similar to mathhs, but works in text mode.

\newenvironment{texthscode}%
  {\(\parray}{\endparray\)}

\newcommand{\texths}{\sethscode{texthscode}}

% The framed environment places code in a framed box.

\def\codeframewidth{\arrayrulewidth}
\RequirePackage{calc}

\newenvironment{framedhscode}%
  {\parskip=\abovedisplayskip\par\noindent
   \hscodestyle
   \arrayrulewidth=\codeframewidth
   \tabular{@{}|p{\linewidth-2\arraycolsep-2\arrayrulewidth-2pt}|@{}}%
   \hline\framedhslinecorrect\\{-1.5ex}%
   \let\endoflinesave=\\
   \let\\=\@normalcr
   \(\pboxed}%
  {\endpboxed\)%
   \framedhslinecorrect\endoflinesave{.5ex}\hline
   \endtabular
   \parskip=\belowdisplayskip\par\noindent
   \ignorespacesafterend}

\newcommand{\framedhslinecorrect}[2]%
  {#1[#2]}

\newcommand{\framedhs}{\sethscode{framedhscode}}

% The inlinehscode environment is an experimental environment
% that can be used to typeset displayed code inline.

\newenvironment{inlinehscode}%
  {\(\def\column##1##2{}%
   \let\>\undefined\let\<\undefined\let\\\undefined
   \newcommand\>[1][]{}\newcommand\<[1][]{}\newcommand\\[1][]{}%
   \def\fromto##1##2##3{##3}%
   \def\nextline{}}{\) }%

\newcommand{\inlinehs}{\sethscode{inlinehscode}}

% The joincode environment is a separate environment that
% can be used to surround and thereby connect multiple code
% blocks.

\newenvironment{joincode}%
  {\let\orighscode=\hscode
   \let\origendhscode=\endhscode
   \def\endhscode{\def\hscode{\endgroup\def\@currenvir{hscode}\\}\begingroup}
   %\let\SaveRestoreHook=\empty
   %\let\ColumnHook=\empty
   %\let\resethooks=\empty
   \orighscode\def\hscode{\endgroup\def\@currenvir{hscode}}}%
  {\origendhscode
   \global\let\hscode=\orighscode
   \global\let\endhscode=\origendhscode}%

\makeatother
\EndFmtInput
%


   % the above one is unnecessary, but included for completeness


% suppress some built-in formatting of lhs2TeX:


%
%
% First, let's redefine the forall, and the dot.
%
%
% This is made in such a way that after a forall, the next
% dot will be printed as a period, otherwise the formatting
% of `comp_` is used. By redefining `comp_`, as suitable
% composition operator can be chosen. Similarly, period_
% is used for the period.
%
\ReadOnlyOnce{forall.fmt}%
\makeatletter

% The HaskellResetHook is a list to which things can
% be added that reset the Haskell state to the beginning.
% This is to recover from states where the hacked intelligence
% is not sufficient.

\let\HaskellResetHook\empty
\newcommand*{\AtHaskellReset}[1]{%
  \g@addto@macro\HaskellResetHook{#1}}
\newcommand*{\HaskellReset}{\HaskellResetHook}

\global\let\hsforallread\empty
\global\let\hsexistsread\empty

\newcommand\hsforall{\global\let\hsdot=\hsperiodonce}
\newcommand\hsexists{\global\let\hsdot=\hsperiodonce}
\newcommand*\hsperiodonce[2]{#2\global\let\hsdot=\hscompose}
\newcommand*\hscompose[2]{#1}

\AtHaskellReset{\global\let\hsdot=\hscompose}

% In the beginning, we should reset Haskell once.
\HaskellReset

\makeatother
\EndFmtInput
\newcommand{\keyword}[1]{\textcolor{BlueViolet}{\textbf{#1}}}
\newcommand{\id}[1]{\textsf{\textsl{#1}}}
\newcommand{\varid}[1]{\textcolor{Sepia}{\id{#1}}}
\newcommand{\conid}[1]{\textcolor{OliveGreen}{\id{#1}}}
%\newcommand{\tick}{\text{\textquoteright}}
\newcommand{\package}[1]{\textsf{#1}}

% Tables should have the caption above
\floatstyle{plaintop}
\restylefloat{table}

\begin{document}

%\special{papersize=8.5in,11in}
\setlength{\pdfpageheight}{\paperheight}
\setlength{\pdfpagewidth}{\paperwidth}

\title{Compositional Trace Semantics for Lambda Calculus}
%\subtitle{Or: Denotational semantics for Call-by-need Lambda Calculus}

\author{Sebastian Graf}
\affiliation{%
  \institution{Karlsruhe Institute of Technology}
  \city{Karlsruhe}
  \country{Germany}
}
\email{sgraf1337@gmail.com}

\author{Simon Peyton Jones}
\affiliation{%
  \institution{Epic Games}
  \city{Cambridge}
  \country{UK}
}
\email{simon.peytonjones@gmail.com}

\ifmain

\begin{abstract}
  We present a class of denotational semantics for lambda calculus that
  generates coinductive traces of a corresponding small-step operational
  semantics.
  The appeal of our method is that the generated traces can be elaborated with
  as much operational detail as needed, and that the structural definition
  enables favorable induction principles.
  Use of Guarded Domain Theory enables mutable state and thus the first
  denotational semantics for call-by-need lambda calculus.
  We demonstrate the usefulness of our trace semantics by proving correct a
  static analysis for estimating the number of variable lookups by abstract
  interpretation.
\end{abstract}

%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\varid{ccs2012}\mathbin{>}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
   <concept>
       <concept_id>10011007.10011006.10011041</concept_id>
       <concept_desc>Software and its engineering~Compilers</concept_desc>
       <concept_significance>500</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011073</concept_id>
       <concept_desc>Software and its engineering~Software maintenance tools</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011008.10011024.10011035</concept_id>
       <concept_desc>Software and its engineering~Procedures, functions and subroutines</concept_desc>
       <concept_significance>100</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011008.10011024.10011032</concept_id>
       <concept_desc>Software and its engineering~Constraints</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011008.10011009.10011012</concept_id>
       <concept_desc>Software and its engineering~Functional languages</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10011007.10011006.10011008.10011009.10011021</concept_id>
       <concept_desc>Software and its engineering~Multiparadigm languages</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
 </ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~Compilers}
\ccsdesc[300]{Software and its engineering~Software maintenance tools}
\ccsdesc[100]{Software and its engineering~Procedures, functions and subroutines}
\ccsdesc[300]{Software and its engineering~Constraints}
\ccsdesc[300]{Software and its engineering~Functional languages}
\ccsdesc[300]{Software and its engineering~Multiparadigm languages}
%% End of generated code

%% Keywords
%% comma separated list
\keywords{Programming language semantics, Abstract Interpretation, Static Program Analysis}  %% \keywords are mandatory in final camera-ready submission

\maketitle

\input{intro.tex}
\input{problem.tex}
\input{interp.tex}
\let\Bbbk\relax


   % the above one is unnecessary, but included for completeness


% suppress some built-in formatting of lhs2TeX:


\section{A Denotational Interpreter}
\label{sec:interp}

\begin{minipage}{0.27\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}c<{\hspost}@{}}%
\column{3E}{@{}l@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\keyword{type}\;\conid{ConTag}\mathrel{=}\conid{Integer}{}\<[E]%
\\
\>[B]{}\keyword{type}\;\conid{D}\;\varid{\ensuremath{\tau}}\mathrel{=}\varid{\ensuremath{\tau}}\;(\conid{Value}\;\varid{\ensuremath{\tau}}){}\<[E]%
\\
\>[B]{}\keyword{data}\;\conid{Value}\;\varid{\ensuremath{\tau}}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mathrel{=}{}\<[3E]%
\>[6]{}\conid{Stuck}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mid {}\<[3E]%
\>[6]{}\conid{Fun}\;(\conid{D}\;\varid{\ensuremath{\tau}}\to \conid{D}\;\varid{\ensuremath{\tau}}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mid {}\<[3E]%
\>[6]{}\conid{Con}\;\conid{ConTag}\;[\mskip1.5mu \conid{D}\;\varid{\ensuremath{\tau}}\mskip1.5mu]{}\<[E]%
\\
\>[B]{}\keyword{data}\;\conid{T}\;\varid{a}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mathrel{=}{}\<[3E]%
\>[6]{}\conid{Delay}\;(\conid{T}\;\varid{a}){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\mid {}\<[3E]%
\>[6]{}\conid{Now}\;\varid{a}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}%
\begin{minipage}{0.43\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\keyword{instance}\;\conid{Monad}\;\conid{T}\;\keyword{where}\mathbin{...}{}\<[E]%
\\
\>[B]{}\keyword{instance}\;\conid{IsTrace}\;\conid{T}\;\keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{lookup}\;\anonymous \mathrel{=}\conid{Delay};\varid{app1}\mathrel{=}\conid{Delay};\mathbin{...}{}\<[E]%
\\
\>[B]{}\keyword{instance}\;\conid{IsValue}\;\conid{T}\;(\conid{Value}\;\conid{T})\;\keyword{where}\mathbin{...}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}%
\begin{minipage}{0.3\textwidth}
\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\keyword{instance}\;\conid{Monad}\;\conid{T}\;\keyword{where}\mathbin{...}{}\<[E]%
\\
\>[B]{}\keyword{instance}\;\conid{IsTrace}\;\conid{T}\;\keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{lookup}\;\anonymous \mathrel{=}\conid{Delay};\varid{app1}\mathrel{=}\conid{Delay};\mathbin{...}{}\<[E]%
\\
\>[B]{}\keyword{instance}\;\conid{IsTrace}\;\varid{\ensuremath{\tau}}\to \conid{IsValue}\;\varid{\ensuremath{\tau}}\;(\conid{Value}\;\varid{\ensuremath{\tau}})\;\keyword{where}\mathbin{...}{}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\end{minipage}

\begin{hscode}\SaveRestoreHook
\column{B}{@{}>{\hspre}l<{\hspost}@{}}%
\column{3}{@{}>{\hspre}l<{\hspost}@{}}%
\column{5}{@{}>{\hspre}l<{\hspost}@{}}%
\column{6}{@{}>{\hspre}l<{\hspost}@{}}%
\column{7}{@{}>{\hspre}l<{\hspost}@{}}%
\column{9}{@{}>{\hspre}l<{\hspost}@{}}%
\column{13}{@{}>{\hspre}l<{\hspost}@{}}%
\column{34}{@{}>{\hspre}l<{\hspost}@{}}%
\column{E}{@{}>{\hspre}l<{\hspost}@{}}%
\>[B]{}\keyword{class}\;\conid{Monad}\;\varid{\ensuremath{\tau}}\Rightarrow \conid{IsTrace}\;\varid{\ensuremath{\tau}}\;\keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{lookup}\mathbin{::}\conid{Name}\to \varid{\ensuremath{\tau}}\;\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{app1},\varid{app2},\varid{bind},\varid{case1},\varid{case2},\varid{update}\mathbin{::}\varid{\ensuremath{\tau}}\;\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\keyword{class}\;\conid{Monad}\;\varid{\ensuremath{\tau}}\Rightarrow \conid{IsValue}\;\varid{\ensuremath{\tau}}\;\varid{v}\;\keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{stuck}\mathbin{::}\varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{injFun}\mathbin{::}(\varid{\ensuremath{\tau}}\;\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v})\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{apply}\mathbin{::}\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{injCon}\mathbin{::}\conid{ConTag}\to [\mskip1.5mu \varid{\ensuremath{\tau}}\;\varid{v}\mskip1.5mu]\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{select}\mathbin{::}\varid{v}\to [\mskip1.5mu (\conid{ConTag},[\mskip1.5mu \varid{\ensuremath{\tau}}\;\varid{v}\mskip1.5mu]\to \varid{\ensuremath{\tau}}\;\varid{v})\mskip1.5mu]\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\[\blanklineskip]%
\>[B]{}\keyword{class}\;\conid{IsTrace}\;\varid{\ensuremath{\tau}}\Rightarrow \conid{HasAlloc}\;\varid{\ensuremath{\tau}}\;\varid{v}\;\keyword{where}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\varid{alloc}\mathbin{::}(\varid{\ensuremath{\tau}}\;\varid{v}\to \varid{\ensuremath{\tau}}\;\varid{v})\to \varid{\ensuremath{\tau}}\;(\varid{\ensuremath{\tau}}\;\varid{v}){}\<[E]%
\\[\blanklineskip]%
\>[B]{}\keyword{type}\;(\rightharpoonup)\mathrel{=}\conid{Map}{}\<[E]%
\\
\>[B]{}\varid{eval}\mathbin{::}\keyword{$\forall$}\!\! \hsforall \;\varid{\ensuremath{\tau}}\;\varid{v}\hsdot{\circ }{.\,}(\conid{IsTrace}\;\varid{\ensuremath{\tau}},\conid{IsValue}\;\varid{\ensuremath{\tau}}\;\varid{v},\conid{HasAlloc}\;\varid{\ensuremath{\tau}}\;\varid{v}){}\<[E]%
\\
\>[B]{}\hsindent{6}{}\<[6]%
\>[6]{}\Rightarrow \conid{Expr}\to (\conid{Name}\rightharpoonup\varid{\ensuremath{\tau}}\;\varid{v})\to \varid{\ensuremath{\tau}}\;\varid{v}{}\<[E]%
\\
\>[B]{}\varid{eval}\;\varid{e}\;\varid{env}\mathrel{=}\keyword{case}\;\varid{e}\;\keyword{of}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{Var}\;\varid{x}\to \varid{\conid{Map}.findWithDefault}\;\varid{stuck}\;\varid{x}\;\varid{env}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{App}\;\varid{e}\;\varid{x}\to \keyword{case}\;\varid{\conid{Map}.lookup}\;\varid{x}\;\varid{env}\;\keyword{of}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\conid{Nothing}\to \varid{stuck}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\conid{Just}\;\varid{d}{}\<[13]%
\>[13]{}\to \varid{app1}\;(\varid{eval}\;\varid{e}\;\varid{env})\bind \lambda \varid{v}\to \varid{apply}\;\varid{v}\;\varid{d}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{Lam}\;\varid{x}\;\varid{e}\to \varid{injFun}\;(\lambda \varid{d}\to \varid{app2}\;(\varid{eval}\;\varid{e}\;(\varid{\conid{Map}.insert}\;\varid{x}\;\varid{d}\;\varid{env}))){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{Let}\;\varid{x}\;\varid{e1}\;\varid{e2}\to \keyword{do}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\keyword{let}\;\varid{ext}\;\varid{d}\mathrel{=}\varid{\conid{Map}.insert}\;\varid{x}\;(\varid{lookup}\;\varid{x}\;\varid{d})\;\varid{env}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\varid{d1}\leftarrow \varid{alloc}\;(\lambda \varid{d1}\to \varid{eval}\;\varid{e1}\;(\varid{ext}\;\varid{d1})){}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\varid{bind}\;(\varid{eval}\;\varid{e2}\;(\varid{ext}\;\varid{d1})){}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{ConApp}\;\varid{k}\;\varid{xs}\to \keyword{case}\;\varid{traverse}\;(\varid{env}\mathbin{\conid{Map}.!?})\;\varid{xs}\;\keyword{of}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\conid{Just}\;\varid{ds}{}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}\mid \varid{length}\;\varid{xs}{}\mathop{==}{}\varid{conArity}\;\varid{k}{}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}\to \varid{injCon}\;\varid{k}\;\varid{ds}{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\anonymous \to \varid{stuck}{}\<[E]%
\\
\>[B]{}\hsindent{3}{}\<[3]%
\>[3]{}\conid{Case}\;\varid{e}\;\varid{alts}\to \varid{case1}\mathbin{\$}\varid{eval}\;\varid{e}\;\varid{env}\bind \lambda \varid{v}\to {}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\varid{select}\;\varid{v}\;[\mskip1.5mu (\varid{k},\varid{alt\char95 cont}\;\varid{xs}\;\varid{rhs})\mid (\varid{k},\varid{xs},\varid{rhs})\leftarrow \varid{alts}\mskip1.5mu]{}\<[E]%
\\
\>[3]{}\hsindent{2}{}\<[5]%
\>[5]{}\keyword{where}{}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}\varid{alt\char95 cont}\;\varid{xs}\;\varid{rhs}\;\varid{ds}{}\<[E]%
\\
\>[7]{}\hsindent{2}{}\<[9]%
\>[9]{}\mid \varid{length}\;\varid{xs}{}\mathop{==}{}\varid{length}\;\varid{ds}\mathrel{=}\varid{case2}\;(\varid{eval}\;\varid{rhs}\;(\varid{insertMany}\;\varid{env}\;\varid{xs}\;\varid{ds})){}\<[E]%
\\
\>[7]{}\hsindent{2}{}\<[9]%
\>[9]{}\mid \varid{otherwise}{}\<[34]%
\>[34]{}\mathrel{=}\varid{stuck}{}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}\varid{insertMany}\mathbin{::}(\conid{Name}\rightharpoonup\varid{\ensuremath{\tau}}\;\varid{v})\to [\mskip1.5mu \conid{Name}\mskip1.5mu]\to [\mskip1.5mu \varid{\ensuremath{\tau}}\;\varid{v}\mskip1.5mu]\to (\conid{Name}\rightharpoonup\varid{\ensuremath{\tau}}\;\varid{v}){}\<[E]%
\\
\>[5]{}\hsindent{2}{}\<[7]%
\>[7]{}\varid{insertMany}\;\varid{env}\;\varid{xs}\;\varid{ds}\mathrel{=}\varid{foldr}\;(\varid{uncurry}\;\varid{\conid{Map}.insert})\;\varid{env}\;(\varid{zip}\;\varid{xs}\;\varid{ds}){}\<[E]%
\ColumnHook
\end{hscode}\resethooks
\input{vanilla.tex}
\input{eventful.tex}
\input{essence.tex}
\input{abstractions.tex}
\input{related-work.tex}

\begin{acks}
We would like to thank the anonymous POPL reviewers for their feedback.
%, as well as Bohdan Liesnikov and Sebastian Ullrich.
\end{acks}

\clearpage
\bibliography{references}

\fi % \ifmain

\end{document}
